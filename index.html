<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة القراءة السريعة - مدارس الرياض الإبداع</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Amiri&family=Tajawal:wght@400;700&family=Almarai:wght@400;700&family=Readex+Pro:wght@400;700&family=Katibeh&family=Lalezar&family=Markazi+Text:wght@400;700&family=Scheherazade+New:wght@400;700&family=Harmattan:wght@400;700&family=El+Messiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* === تصميم أنيق وعصري === */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3f37c9;
            --accent: #f72585;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #0f172a;
            --text-light: #475569;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --radius-lg: 32px;
            --radius-md: 24px;
            --radius-sm: 16px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
        }

        [data-theme="comfort"] {
            --bg: #f5e9da;
            --card-bg: #fff7ed;
            --text: #5e4b3c;
            --text-light: #8b7a6b;
            --border: #d9c9b4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
            transition: var(--transition);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* === الهيدر === */
        .header {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 16px 28px;
            margin-bottom: 28px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .school-logo {
            height: 64px;
            width: auto;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .header p {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .theme-buttons {
            display: flex;
            gap: 10px;
        }

        .theme-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .theme-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* === الشبكة الرئيسية - تصغير العمود الأيمن === */
        .main-grid {
            display: grid;
            grid-template-columns: 0.8fr 1.5fr; /* العمود الأيمن أصغر */
            gap: 28px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* === العمود الأيمن: الإعدادات (مصغر) === */
        .settings-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 18px; /* تقليل padding */
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 20px;
        }

        .section-title {
            font-size: 1rem; /* تصغير */
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }

        .section-title i {
            font-size: 1.1rem; /* تصغير الأيقونة */
        }

        /* شريط الخطوط الأفقي القابل للتمرير */
        .font-scroll-bar {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 2px 0 10px;
            margin-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--border);
        }

        .font-scroll-bar::-webkit-scrollbar {
            height: 4px;
        }

        .font-scroll-bar::-webkit-scrollbar-track {
            background: var(--border);
            border-radius: 10px;
        }

        .font-scroll-bar::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .font-mini-btn {
            white-space: nowrap;
            padding: 6px 12px; /* تقليل */
            border-radius: 30px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 0.75rem; /* تصغير الخط */
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .font-mini-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.02);
        }

        /* تحكم الحجم */
        .size-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg);
            padding: 4px 8px; /* تقليل */
            border-radius: 30px;
            border: 1px solid var(--border);
            margin-bottom: 14px;
            width: fit-content;
        }

        .size-btn {
            width: 28px; /* تصغير */
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .size-btn:hover {
            background: var(--primary);
            color: white;
        }

        #fontSizeValue {
            min-width: 32px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* صندوق المعاينة */
        .preview-box {
            background: var(--bg);
            border-radius: var(--radius-md);
            padding: 12px; /* تقليل */
            border: 1px solid var(--border);
            text-align: center;
            margin: 16px 0;
        }

        .preview-box p {
            color: var(--text-light);
            font-size: 0.75rem;
            margin-bottom: 6px;
        }

        .preview-text {
            font-size: 22px; /* تصغير */
            line-height: 1.5;
            color: var(--primary);
            font-weight: 600;
            transition: font-family 0.2s, font-size 0.2s;
            word-break: break-word;
        }

        /* أزرار أوضاع القراءة بشكل كروت مصغرة */
        .mode-cards {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }

        .mode-card {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm); /* أصغر */
            padding: 12px 4px; /* تقليل */
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .mode-card i {
            font-size: 1.5rem; /* تصغير الأيقونة */
            color: var(--primary);
            margin-bottom: 4px;
        }

        .mode-card span {
            display: block;
            font-weight: 600;
            font-size: 0.75rem; /* تصغير */
        }

        .mode-card.active {
            border: 2px solid var(--primary);
            background: color-mix(in srgb, var(--primary) 8%, var(--bg));
            transform: translateY(-2px);
        }

        /* شريط السرعة */
        .speed-section {
            margin-bottom: 18px;
        }

        .speed-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .speed-label span {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .speed-value {
            font-size: 1.6rem; /* تصغير */
            font-weight: 700;
            color: var(--primary);
        }

        input[type=range] {
            width: 100%;
            height: 5px; /* أقل ارتفاعاً */
            background: var(--border);
            border-radius: 10px;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; /* أصغر */
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* فلاتر الفصل والصف */
        .filter-group {
            margin-bottom: 16px;
        }

        .filter-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 14px; /* تقليل */
            border-radius: 30px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 0.7rem; /* تصغير */
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* === العمود الأيسر: الدروس وزر البدء (كما هو) === */
        .lessons-column {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: fit-content;
        }

        .lessons-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .lessons-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg);
            padding: 6px 14px;
            border-radius: 40px;
            border: 1px solid var(--border);
        }

        .search-box i {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .search-box input {
            border: none;
            background: transparent;
            color: var(--text);
            outline: none;
            width: 140px;
            font-size: 0.85rem;
        }

        .search-box input::placeholder {
            color: var(--text-light);
        }

        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
            max-height: 450px;
            overflow-y: auto;
            padding: 4px;
            scrollbar-width: thin;
        }

        .lessons-grid::-webkit-scrollbar {
            width: 4px;
        }

        .lessons-grid::-webkit-scrollbar-track {
            background: var(--border);
            border-radius: 10px;
        }

        .lessons-grid::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .lesson-item {
            background: var(--bg);
            padding: 16px 8px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .lesson-item:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .lesson-item.selected {
            border: 2px solid var(--primary);
            background: color-mix(in srgb, var(--primary) 10%, var(--bg));
        }

        .lesson-item i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .word-count-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 40px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .lesson-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .start-btn-container {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .btn-launch {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 10px 20px -5px var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-launch:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -5px var(--primary-dark);
        }

        .btn-launch:disabled {
            background: var(--border);
            color: var(--text-light);
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-launch i {
            font-size: 1.2rem;
        }

        .admin-link {
            text-align: center;
            margin-top: 16px;
            font-size: 0.75rem;
        }

        .admin-link a {
            color: var(--text-light);
            text-decoration: none;
            transition: var(--transition);
        }

        .admin-link a:hover {
            color: var(--primary);
        }

        .loading-spinner {
            grid-column: 1/-1;
            text-align: center;
            padding: 40px;
            color: var(--primary);
            font-size: 1.2rem;
        }
    </style>
</head>
<body data-theme="light">
<div class="container">
    <!-- الهيدر (كما هو) -->
    <div class="header">
        <div class="logo-container">
            <img src="https://www.wzufa.com/wp-content/uploads/2022/07/Riyadh-Al-Ebdaa-Schools.png" alt="شعار مدارس الرياض الإبداع" class="school-logo">
            <div>
                <h1>منصة القراءة السريعة</h1>
                <p>مدارس رياض الإبداع الأهلية</p>
            </div>
        </div>
        <div class="theme-buttons">
            <div class="theme-btn light" onclick="setTheme('light')" title="الوضع النهاري"><i class="fas fa-sun"></i></div>
            <div class="theme-btn dark" onclick="setTheme('dark')" title="الوضع الليلي"><i class="fas fa-moon"></i></div>
            <div class="theme-btn comfort" onclick="setTheme('comfort')" title="الوضع المريح"><i class="fas fa-leaf"></i></div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="main-grid">
        <!-- العمود الأيمن: الإعدادات (مصغر) -->
        <div class="settings-card">
            <h3 class="section-title"><i class="fas fa-sliders-h"></i> الإعدادات</h3>
            
            <!-- شريط الخطوط -->
            <div class="font-scroll-bar" id="miniFontSelector">
                <span class="font-mini-btn" data-font="'Cairo', sans-serif" style="font-family: 'Cairo';">كايرو</span>
                <span class="font-mini-btn" data-font="'Amiri', serif" style="font-family: 'Amiri';">أميري</span>
                <span class="font-mini-btn" data-font="'Tajawal', sans-serif" style="font-family: 'Tajawal';">تجوال</span>
                <span class="font-mini-btn" data-font="'Almarai', sans-serif" style="font-family: 'Almarai';">المرائي</span>
                <span class="font-mini-btn" data-font="'Readex Pro', sans-serif" style="font-family: 'Readex Pro';">ريدكس</span>
                <span class="font-mini-btn" data-font="'Katibeh', cursive" style="font-family: 'Katibeh';">كايور</span>
                <span class="font-mini-btn" data-font="'Harmattan', sans-serif" style="font-family: 'Harmattan';">همنان</span>
                <span class="font-mini-btn" data-font="'El Messiri', sans-serif" style="font-family: 'El Messiri';">مركزي</span>
                <span class="font-mini-btn" data-font="'Lalezar', cursive" style="font-family: 'Lalezar';">لطيف</span>
                <span class="font-mini-btn" data-font="'Markazi Text', serif" style="font-family: 'Markazi Text';">ليازار</span>
                <span class="font-mini-btn" data-font="'Scheherazade New', serif" style="font-family: 'Scheherazade New';">شهزاد</span>
            </div>

            <!-- تحكم الحجم -->
            <div class="size-controls">
                <button class="size-btn" id="decreaseFontSize"><i class="fas fa-minus"></i></button>
                <span id="fontSizeValue">28</span>
                <button class="size-btn" id="increaseFontSize"><i class="fas fa-plus"></i></button>
            </div>

            <!-- معاينة الخط -->
            <div class="preview-box">
                <p>معاينة الخط</p>
                <div class="preview-text" id="fontPreview">أسامة إبراهيم محمدي</div>
            </div>

            <!-- أوضاع القراءة -->
            <div class="mode-cards" id="modeSelector">
                <div class="mode-card" data-mode="rsvp">
                    <i class="fas fa-bolt"></i>
                    <span>كلمة بكلمة</span>
                </div>
                <div class="mode-card" data-mode="scroll">
                    <i class="fas fa-scroll"></i>
                    <span>تمرير انسيابي</span>
                </div>
                <div class="mode-card" data-mode="static">
                    <i class="fas fa-book-open"></i>
                    <span>نص ثابت</span>
                </div>
            </div>

            <!-- السرعة -->
            <div class="speed-section">
                <div class="speed-label">
                    <span><i class="fas fa-tachometer-alt"></i> السرعة</span>
                    <span class="speed-value" id="speedVal">150</span>
                </div>
                <input type="range" id="speedSlider" min="10" max="400" step="10" value="150">
            </div>

            <!-- فلاتر -->
            <div class="filter-group">
                <div class="filter-title"><i class="fas fa-calendar-alt"></i> الفصل</div>
                <div class="filter-buttons" id="semesterSelector">
                    <div class="filter-btn" data-semester="1">الأول</div>
                    <div class="filter-btn" data-semester="2">الثاني</div>
                </div>
            </div>

            <div class="filter-group">
                <div class="filter-title"><i class="fas fa-graduation-cap"></i> الصف</div>
                <div class="filter-buttons" id="gradeSelector">
                    <div class="filter-btn" data-grade="1">الأول</div>
                    <div class="filter-btn" data-grade="2">الثاني</div>
                    <div class="filter-btn" data-grade="3">الثالث</div>
                    <div class="filter-btn" data-grade="4">الرابع</div>
                    <div class="filter-btn" data-grade="5">الخامس</div>
                    <div class="filter-btn" data-grade="6">السادس</div>
                </div>
            </div>
        </div>

        <!-- العمود الأيسر: الدروس وزر البدء -->
        <div class="lessons-column">
            <div class="lessons-header">
                <h3><i class="fas fa-book"></i> النصوص المتاحة</h3>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="بحث..." autocomplete="off">
                </div>
            </div>

            <div id="lessonsGrid" class="lessons-grid">
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> جاري تحميل النصوص...</div>
            </div>

            <div class="start-btn-container">
                <button class="btn-launch" id="startBtn" onclick="launchReader()" disabled>
                    <i class="fas fa-play"></i> ابدأ القراءة
                </button>
            </div>

            <div class="admin-link">
                <a href="admin.html"><i class="fas fa-lock"></i> لوحة الإدارة</a>
            </div>
        </div>
    </div>
</div>

<!-- نفس السكربت السابق بدون تغيير -->
<script>
    // ========== بيانات الدروس ==========
    let lessonsData = [];
    let selectedLessonId = null;
    let currentFont = "'Cairo', sans-serif";
    let currentMode = 'rsvp';
    let currentSpeed = 150;
    let currentSemester = '1';
    let currentGrade = '1';
    let currentFontSize = 28;
    let searchTerm = '';

    // عناصر DOM
    const lessonsGrid = document.getElementById('lessonsGrid');
    const startBtn = document.getElementById('startBtn');
    const fontPreview = document.getElementById('fontPreview');
    const searchInput = document.getElementById('searchInput');

    // دوال تحويل رقم الصف والفصل إلى النص الكامل
    function getGradeFullName(gradeNumber) {
        const grades = [
            'الأول الابتدائي',
            'الثاني الابتدائي',
            'الثالث الابتدائي',
            'الرابع الابتدائي',
            'الخامس الابتدائي',
            'السادس الابتدائي'
        ];
        return grades[gradeNumber - 1];
    }

    function getSemesterFullName(semesterNumber) {
        return semesterNumber === '1' ? 'الفصل الدراسي الأول' : 'الفصل الدراسي الثاني';
    }

    // تحديث معاينة الخط
    function updateFontPreview() {
        fontPreview.style.fontFamily = currentFont;
        fontPreview.style.fontSize = currentFontSize + 'px';
    }

    // ========== تحميل الدروس وحفظها في localStorage ==========
    async function loadAllLessons() {
        const files = [
            'primary_first.json',
            'primary_second.json',
            'upper_first.json',
            'upper_second.json'
        ];

        try {
            const promises = files.map(file => fetch(file).then(res => res.json()));
            const results = await Promise.all(promises);

            lessonsData = [];
            results.forEach(lessonsArray => {
                lessonsArray.forEach(lesson => {
                    lessonsData.push(lesson);
                });
            });

            // حفظ الدروس في localStorage لصفحة read.html
            localStorage.setItem('reading_app_lessons', JSON.stringify(lessonsData));

            renderLessons();
        } catch (error) {
            console.error('خطأ في تحميل الدروس:', error);
            lessonsGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:30px; color:var(--danger);">
                <i class="fas fa-exclamation-triangle fa-3x"></i>
                <p>فشل تحميل الدروس. تأكد من وجود الملفات الأربعة في نفس المجلد.</p>
            </div>`;
        }
    }

    // عرض الدروس في الشبكة مع فلترة
    function renderLessons() {
        const targetGradeName = getGradeFullName(currentGrade);
        const targetSemesterName = getSemesterFullName(currentSemester);
        
        let filteredLessons = lessonsData.filter(l => 
            l.grade === targetGradeName && l.semester === targetSemesterName
        );

        // تطبيق البحث
        if (searchTerm.trim() !== '') {
            const term = searchTerm.trim().toLowerCase();
            filteredLessons = filteredLessons.filter(l => l.title.toLowerCase().includes(term));
        }

        if (filteredLessons.length === 0) {
            lessonsGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:30px; color:var(--text-light);">
                <i class="fas fa-folder-open fa-3x"></i>
                <p>لا توجد نصوص تطابق البحث</p>
            </div>`;
            startBtn.disabled = true;
            return;
        }

        lessonsGrid.innerHTML = filteredLessons.map(l => {
            const wordCount = l.content.split(/\s+/).length;
            return `
                <div class="lesson-item ${selectedLessonId === l.id ? 'selected' : ''}" onclick="selectLesson('${l.id}')">
                    <span class="word-count-badge">${wordCount}</span>
                    <i class="fas fa-file-alt"></i>
                    <div class="lesson-title">${escapeHtml(l.title)}</div>
                </div>
            `;
        }).join('');

        startBtn.disabled = !selectedLessonId;
    }

    window.selectLesson = function(id) {
        selectedLessonId = id;
        renderLessons();
    };

    function launchReader() {
        if (!selectedLessonId) {
            alert("يرجى اختيار نص أولاً");
            return;
        }
        const lesson = lessonsData.find(l => l.id === selectedLessonId);
        if (!lesson) return;

        const config = {
            lessonId: selectedLessonId,
            speed: currentSpeed,
            mode: currentMode,
            font: currentFont,
            theme: document.body.getAttribute('data-theme'),
            fontSize: currentFontSize
        };

        sessionStorage.setItem('reader_config', JSON.stringify(config));
        window.location.href = 'read.html';
    }

    // ========== إعدادات المستخدم ==========
    window.setTheme = function(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    };

    (function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
    })();

    function loadUserPrefs() {
        const prefs = JSON.parse(localStorage.getItem('USER_PREFS_KEY')) || {};
        
        if (prefs.font) {
            currentFont = prefs.font;
            document.querySelectorAll('.font-mini-btn').forEach(btn => {
                if (btn.dataset.font === prefs.font) btn.classList.add('active');
            });
        } else {
            document.querySelector('.font-mini-btn[data-font="\'Cairo\', sans-serif"]').classList.add('active');
        }
        
        if (prefs.mode) {
            currentMode = prefs.mode;
            document.querySelectorAll('.mode-card').forEach(card => {
                if (card.dataset.mode === prefs.mode) card.classList.add('active');
            });
        } else {
            document.querySelector('.mode-card[data-mode="rsvp"]').classList.add('active');
        }
        
        if (prefs.speed) {
            currentSpeed = prefs.speed;
            document.getElementById('speedSlider').value = currentSpeed;
            document.getElementById('speedVal').innerText = currentSpeed;
        }
        
        if (prefs.semester) {
            currentSemester = prefs.semester;
        }
        document.querySelectorAll('#semesterSelector .filter-btn').forEach(btn => {
            if (btn.dataset.semester === currentSemester) btn.classList.add('active');
        });
        
        if (prefs.grade) {
            currentGrade = prefs.grade;
        }
        document.querySelectorAll('#gradeSelector .filter-btn').forEach(btn => {
            if (btn.dataset.grade === currentGrade) btn.classList.add('active');
        });
        
        if (prefs.fontSize) {
            currentFontSize = prefs.fontSize;
            document.getElementById('fontSizeValue').innerText = currentFontSize;
        }

        // تحديث المعاينة
        updateFontPreview();
    }

    function saveUserPrefs() {
        const prefs = {
            font: currentFont,
            mode: currentMode,
            speed: currentSpeed,
            semester: currentSemester,
            grade: currentGrade,
            fontSize: currentFontSize
        };
        localStorage.setItem('USER_PREFS_KEY', JSON.stringify(prefs));
    }

    // ========== Event Listeners ==========
    document.getElementById('speedSlider').addEventListener('input', function(e) {
        currentSpeed = e.target.value;
        document.getElementById('speedVal').innerText = currentSpeed;
        saveUserPrefs();
    });

    document.querySelectorAll('.font-mini-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.font-mini-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFont = this.dataset.font;
            updateFontPreview();
            saveUserPrefs();
        });
    });

    document.getElementById('increaseFontSize').addEventListener('click', () => {
        currentFontSize += 2;
        document.getElementById('fontSizeValue').innerText = currentFontSize;
        updateFontPreview();
        saveUserPrefs();
    });
    document.getElementById('decreaseFontSize').addEventListener('click', () => {
        if (currentFontSize > 12) {
            currentFontSize -= 2;
            document.getElementById('fontSizeValue').innerText = currentFontSize;
            updateFontPreview();
            saveUserPrefs();
        }
    });

    document.querySelectorAll('.mode-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            currentMode = this.dataset.mode;
            saveUserPrefs();
        });
    });

    document.querySelectorAll('#semesterSelector .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#semesterSelector .filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentSemester = this.dataset.semester;
            saveUserPrefs();
            selectedLessonId = null;
            renderLessons();
        });
    });

    document.querySelectorAll('#gradeSelector .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#gradeSelector .filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentGrade = this.dataset.grade;
            saveUserPrefs();
            selectedLessonId = null;
            renderLessons();
        });
    });

    searchInput.addEventListener('input', function(e) {
        searchTerm = e.target.value;
        renderLessons();
    });

    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<>"]/g, function(m) {
            if (m === '&') return '&amp;';
            if (m === '<') return '&lt;';
            if (m === '>') return '&gt;';
            if (m === '"') return '&quot;';
            return m;
        });
    }

    // التهيئة
    window.onload = () => {
        loadUserPrefs();
        loadAllLessons();
        startBtn.disabled = true;
    };
</script>
</body>
</html>
