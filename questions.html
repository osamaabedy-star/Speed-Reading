<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ø£Ø³Ø¦Ù„Ø© Â· Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* === ØªØµÙ…ÙŠÙ… Ù…Ø´ÙˆÙ‚ Ù„Ù„ØµØºØ§Ø± Ù…Ø¹ Ø£Ù„ÙˆØ§Ù† Ù…Ø¨Ù‡Ø¬Ø© === */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Cairo', 'Segoe UI', Tahoma, sans-serif; }

        :root {
            --bg: #f0f9ff;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #475569;
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #e2e8f0;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
        }

        [data-theme="comfort"] {
            --bg: #fef9c3;
            --card-bg: #fffbeb;
            --text: #78350f;
            --text-light: #92400e;
            --border: #fcd34d;
        }

        body {
            background: var(--bg);
            color: var(--text);
            padding: 12px;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
            font-size: 15px;
        }

        .container { max-width: 950px; margin: 0 auto; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³ */
        .header {
            background: var(--card-bg);
            border-radius: 60px;
            padding: 10px 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .lesson-name {
            background: var(--bg);
            padding: 5px 18px;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            border: 1px solid var(--border);
        }

        .btn-home {
            background: transparent;
            color: var(--text);
            border: 2px solid var(--border);
            padding: 6px 14px;
            border-radius: 40px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: 0.2s;
        }
        .btn-home:hover { background: var(--border); }

        /* Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            background: var(--card-bg);
            padding: 8px 20px;
            border-radius: 40px;
            border: 1px solid var(--border);
        }

        .question-counter {
            background: var(--primary);
            color: white;
            padding: 4px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ */
        .question-box {
            background: var(--card-bg);
            border-radius: 40px;
            padding: 22px;
            border: 2px solid var(--border);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
        }

        /* === Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªÙ†ÙˆØ¹Ø© === */

        /* 1. Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ (mcq) */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        .option-btn {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 60px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 600;
            font-size: 1rem;
        }
        .option-btn:hover { border-color: var(--primary); background: color-mix(in srgb, var(--primary) 8%, var(--bg)); }
        .option-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .option-btn.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .option-btn.wrong {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* 2. ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ / Ø§Ù„Ø¬Ù…Ù„ */
        .order-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        .order-item-row {
            display: flex;
            align-items: center;
            gap: 12px;
            background: color-mix(in srgb, var(--bg) 80%, black 5%);
            border-radius: 50px;
            padding: 12px 18px;
            border: 2px solid var(--border);
            cursor: grab;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }
        .order-item-row.dragging {
            opacity: 0.6;
            cursor: grabbing;
            transform: scale(1.02);
        }
        .order-item-row.drag-over {
            border-color: var(--primary);
            border-width: 3px;
        }
        .order-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .order-item-text {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .drag-handle {
            color: var(--text-light);
            font-size: 1.3rem;
            cursor: grab;
        }

        /* 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ù†Ø§Ù‚Øµ */
        .missing-letters {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            font-size: 2rem;
            font-weight: 700;
        }
        .missing-word {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg);
            padding: 10px 20px;
            border-radius: 60px;
            border: 2px solid var(--border);
        }
        .missing-letter {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px dashed var(--primary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            cursor: pointer;
            transition: 0.2s;
        }
        .missing-letter.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .letter-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        .letter-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }
        .letter-option:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            color: white;
        }
        .letter-option.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* 4. ØµØ­ Ø£Ù… Ø®Ø·Ø£ */
        .truefalse-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .tf-btn {
            padding: 15px 30px;
            border-radius: 60px;
            font-size: 1.3rem;
            font-weight: 700;
            border: 2px solid var(--border);
            background: var(--bg);
            cursor: pointer;
            min-width: 120px;
            text-align: center;
        }
        .tf-btn.true:hover { border-color: var(--success); background: color-mix(in srgb, var(--success) 15%, var(--bg)); }
        .tf-btn.false:hover { border-color: var(--danger); background: color-mix(in srgb, var(--danger) 15%, var(--bg)); }
        .tf-btn.selected.true { background: var(--success); color: white; border-color: var(--success); }
        .tf-btn.selected.false { background: var(--danger); color: white; border-color: var(--danger); }

        /* 5. ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ */
        .syllable-sort {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .syllable-words {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .word-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 40px;
            padding: 10px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: grab;
        }
        .word-card.dragging { opacity: 0.5; }
        .category-boxes {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .category-box {
            flex: 1;
            background: var(--card-bg);
            border: 2px dashed var(--border);
            border-radius: 30px;
            padding: 15px;
            min-height: 100px;
            text-align: center;
        }
        .category-box.drag-over { border-color: var(--primary); background: color-mix(in srgb, var(--primary) 10%, var(--bg)); }
        .category-title { font-weight: 700; margin-bottom: 10px; }
        .category-items { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }

        /* 6. Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„ */
        .match-first {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .match-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .match-word {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 40px;
            padding: 10px 20px;
            font-size: 1.2rem;
        }
        .match-letters {
            display: flex;
            gap: 8px;
        }
        .match-letter {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
        }
        .match-letter.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin: 15px 0;
        }
        .nav-btn {
            padding: 10px 22px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            color: var(--text);
            border: 2px solid var(--border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .nav-btn:hover:not(:disabled) { background: var(--primary); color: white; }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Ø²Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ… */
        .submit-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: 0.2s;
            box-shadow: 0 4px 12px rgba(16,185,129,0.4);
        }
        .submit-btn:hover:not(:disabled) { transform: scale(1.02); }
        .submit-btn:disabled { background: var(--border); cursor: not-allowed; opacity: 0.7; }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 50px;
            max-width: 550px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            text-align: center;
            position: relative;
            border: 2px solid var(--border);
        }
        .close-modal {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
        }
        .close-modal:hover { color: var(--danger); }

        .report-header {
            display: flex;
            justify-content: space-around;
            background: var(--bg);
            border-radius: 40px;
            padding: 12px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .report-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1rem;
        }
        .error-details {
            text-align: right;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .error-item {
            background: var(--bg);
            border-radius: 30px;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-right: 5px solid var(--danger);
        }
        .pie {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(var(--success) 0deg, var(--border) 0deg);
        }
        .result-emoji { font-size: 3rem; }
        .result-score { font-size: 2.2rem; font-weight: 700; color: var(--primary); }

        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù„Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ */
        .grade1-welcome {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 60px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            box-shadow: 0 6px 14px rgba(245,158,11,0.3);
        }
    </style>
</head>
<body data-theme="light">
<div class="container">
    <!-- Ù‡ÙŠØ¯Ø± Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³ -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-star" style="color: #fbbf24;"></i>
            <span>Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
        </div>
        <div class="lesson-name" id="headerLessonName">...</div>
        <a href="index.html" class="btn-home"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>

    <!-- Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯Ø±Ø³ Ù„Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„) -->
    <div id="grade1Welcome" class="grade1-welcome" style="display: none;">
        <i class="fas fa-smile-beam"></i> Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ Ø¨Ø·Ù„! Ø§Ø³ØªØ¹Ø¯ Ù„Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„ÙƒÙ„Ù…Ø§Øª <i class="fas fa-smile-beam"></i>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
    <div id="questionsSection">
        <div class="questions-header">
            <h3><i class="fas fa-pencil-alt"></i> Ø£Ø¬Ø¨ Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
            <span class="question-counter" id="questionCounter">1 / 0</span>
        </div>
        <div id="questionContainer" class="question-box"></div>
        <div class="navigation-buttons">
            <button class="nav-btn" id="prevBtn" disabled><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="nav-btn" id="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
        </div>
        <button class="submit-btn" id="submitBtn" disabled>Ø³Ù„Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModalBtn">&times;</span>
            <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h2>
            <div class="report-header">
                <div class="report-stat"><i class="fas fa-tachometer-alt"></i> Ø§Ù„Ø³Ø±Ø¹Ø©: <span id="reportSpeed">0</span> Ùƒ/Ø¯</div>
                <div class="report-stat"><i class="fas fa-exclamation-triangle" style="color:var(--danger);"></i> Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <span id="reportErrors">0</span></div>
                <div class="report-stat"><i class="fas fa-clock"></i> Ø§Ù„Ø²Ù…Ù†: <span id="reportDuration">0</span> Ø«</div>
            </div>
            <div class="result-emoji" id="modalResultEmoji">ğŸ†</div>
            <div class="result-score" id="modalResultScore">0%</div>
            <div class="result-message" id="modalResultMessage"></div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 15px 0;">
                <div class="pie" id="modalPieChart"></div>
                <div>
                    <div><span style="color:var(--success);">â—</span> <span id="modalCorrectCount">0</span> ØµØ­ÙŠØ­</div>
                    <div><span style="color:var(--border);">â—</span> <span id="modalWrongCount">0</span> Ø®Ø·Ø£</div>
                </div>
            </div>
            <div id="errorDetailsContainer" class="error-details"></div>
            <button class="modal-btn" id="modalCloseBtn" style="background:var(--primary); color:white; border:none; padding:10px 25px; border-radius:40px;">Ø¥ØºÙ„Ø§Ù‚</button>
            <a href="index.html" class="btn-home" style="display:inline-block; margin-top:10px;"><i class="fas fa-book"></i> Ù†Øµ Ø¢Ø®Ø±</a>
        </div>
    </div>
</div>

<script>
    (function() {
        const STORAGE_SESSIONS = 'reading_sessions';
        const sessionData = JSON.parse(sessionStorage.getItem('currentReadingSession'));

        if (!sessionData) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù„Ø³Ø© Ù‚Ø±Ø§Ø¡Ø©ØŒ Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
            window.location.href = 'index.html';
            return;
        }

        const lessonTitle = sessionData.lessonTitle;
        const grade = sessionData.grade; // Ù…Ø«Ù„ "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ"
        const speed = sessionData.speed;
        const errorsCount = sessionData.errors || 0;
        const duration = sessionData.duration; // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
        const allQuestions = sessionData.questions || [];

        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³
        document.getElementById('headerLessonName').textContent = lessonTitle;

        // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
        if (grade && grade.includes('Ø§Ù„Ø£ÙˆÙ„')) {
            document.getElementById('grade1Welcome').style.display = 'block';
        }

        if (!allQuestions || allQuestions.length === 0) {
            document.getElementById('questionsSection').innerHTML = '<div style="background:var(--card-bg); border-radius:60px; padding:40px; text-align:center;"><i class="fas fa-smile-wink fa-4x"></i><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ</h3></div>';
            return;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
        function validateQuestion(q) {
            if (!q) return false;
            switch (q.type) {
                case 'mcq': return q.options && Array.isArray(q.options) && q.correct !== undefined;
                case 'order': return q.items && Array.isArray(q.items) && q.correctOrder && Array.isArray(q.correctOrder);
                case 'missing_letter': return q.word && q.missingIndex !== undefined && q.options && Array.isArray(q.options);
                case 'truefalse': return q.statement && q.correct !== undefined; // true/false
                case 'syllable_sort': return q.words && Array.isArray(q.words) && q.categories && Array.isArray(q.categories);
                case 'match_first': return q.words && Array.isArray(q.words) && q.letters && Array.isArray(q.letters);
                case 'sentence_order': return q.words && Array.isArray(q.words) && q.correctOrder && Array.isArray(q.correctOrder);
                default: return false;
            }
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
        const validQuestions = allQuestions.filter(q => validateQuestion(q));
        if (validQuestions.length === 0) {
            document.getElementById('questionsSection').innerHTML = '<div style="background:var(--card-bg); border-radius:60px; padding:40px; text-align:center;"><i class="fas fa-exclamation-triangle fa-4x"></i><h3>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©</h3></div>';
            return;
        }

        // Ø§Ø®ØªÙŠØ§Ø± 10 Ø£Ø³Ø¦Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        function selectQuestions(questionsArray, count = 10) {
            const shuffled = [...questionsArray];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            let selected = shuffled.slice(0, count);
            if (selected.length < count) {
                while (selected.length < count) {
                    selected.push({ ...selected[0] }); // ØªÙƒØ±Ø§Ø± Ø£ÙˆÙ„ Ø³Ø¤Ø§Ù„
                }
            }
            return selected;
        }

        let questions = selectQuestions(validQuestions, 10);
        let currentIndex = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let quizSubmitted = false;
        let correctCount = 0;

        // Ø¹Ù†Ø§ØµØ± DOM
        const questionContainer = document.getElementById('questionContainer');
        const questionCounter = document.getElementById('questionCounter');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const reportModal = document.getElementById('reportModal');
        const modalResultEmoji = document.getElementById('modalResultEmoji');
        const modalResultScore = document.getElementById('modalResultScore');
        const modalResultMessage = document.getElementById('modalResultMessage');
        const modalPieChart = document.getElementById('modalPieChart');
        const modalCorrectCount = document.getElementById('modalCorrectCount');
        const modalWrongCount = document.getElementById('modalWrongCount');
        const reportSpeed = document.getElementById('reportSpeed');
        const reportErrors = document.getElementById('reportErrors');
        const reportDuration = document.getElementById('reportDuration');
        const errorDetailsContainer = document.getElementById('errorDetailsContainer');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ…
        if (sessionData.theme) document.body.setAttribute('data-theme', sessionData.theme);
        else {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        function updateCounter() {
            questionCounter.textContent = `${currentIndex + 1} / ${questions.length}`;
        }

        // ========== Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ ==========
        function renderQuestion() {
            const q = questions[currentIndex];
            if (!q) return;

            let html = `<div class="question-text">${currentIndex + 1}. ${escapeHtml(q.text || '')}</div>`;

            switch (q.type) {
                case 'mcq':
                    html += renderMCQ(q);
                    break;
                case 'order':
                case 'sentence_order':
                    html += renderOrder(q);
                    break;
                case 'missing_letter':
                    html += renderMissingLetter(q);
                    break;
                case 'truefalse':
                    html += renderTrueFalse(q);
                    break;
                case 'syllable_sort':
                    html += renderSyllableSort(q);
                    break;
                case 'match_first':
                    html += renderMatchFirst(q);
                    break;
                default:
                    html += `<p>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</p>`;
            }

            questionContainer.innerHTML = html;

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            prevBtn.disabled = (currentIndex === 0) || quizSubmitted;
            nextBtn.disabled = (currentIndex === questions.length - 1) || quizSubmitted;

            const allAnswered = userAnswers.every(ans => {
                if (ans === null) return false;
                if (Array.isArray(ans)) return ans.length > 0 && ans.every(a => a !== null);
                return true;
            });
            submitBtn.disabled = !allAnswered || quizSubmitted;
        }

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ù†ÙˆØ¹
        function renderMCQ(q) {
            const options = q.options || [];
            let optsHtml = '<div class="options-grid">';
            options.forEach((opt, idx) => {
                let cls = 'option-btn';
                if (userAnswers[currentIndex] === idx) cls += ' selected';
                if (quizSubmitted) {
                    if (idx === q.correct) cls += ' correct';
                    else if (userAnswers[currentIndex] === idx) cls += ' wrong';
                }
                const onClick = quizSubmitted ? '' : `selectMCQ(${currentIndex}, ${idx})`;
                optsHtml += `<div class="${cls}" onclick="${onClick}">${escapeHtml(opt)}</div>`;
            });
            optsHtml += '</div>';
            return optsHtml;
        }

        function renderOrder(q) {
            const items = q.items || q.words || [];
            if (items.length === 0) return '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</p>';
            let currentOrder = userAnswers[currentIndex];
            if (!currentOrder) {
                currentOrder = [...items];
                userAnswers[currentIndex] = currentOrder;
            }
            let html = '<div class="order-container">';
            currentOrder.forEach((item, idx) => {
                html += `
                    <div class="order-item-row" draggable="${!quizSubmitted}" 
                         ondragstart="dragStart(event, ${idx})"
                         ondragover="dragOver(event, ${idx})"
                         ondragleave="dragLeave(event)"
                         ondrop="drop(event, ${idx})"
                         ondragend="dragEnd(event)">
                        <span class="order-number">${idx + 1}</span>
                        <span class="order-item-text">${escapeHtml(item)}</span>
                        <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderMissingLetter(q) {
            const word = q.word || '';
            const missingIdx = q.missingIndex || 0;
            const options = q.options || [];
            let currentAnswer = userAnswers[currentIndex];
            if (currentAnswer === null) currentAnswer = null;
            let html = `<div class="missing-letters">`;
            for (let i = 0; i < word.length; i++) {
                if (i === missingIdx) {
                    html += `<span class="missing-letter" onclick="selectMissing(${currentIndex})">${currentAnswer !== null ? currentAnswer : '?'}</span>`;
                } else {
                    html += `<span style="font-size:2rem;">${word[i]}</span>`;
                }
            }
            html += '</div><div class="letter-options">';
            options.forEach((opt, idx) => {
                const disabled = (currentAnswer !== null) ? 'disabled' : '';
                html += `<span class="letter-option ${disabled}" onclick="chooseMissing(${currentIndex}, '${opt}')">${opt}</span>`;
            });
            html += '</div>';
            return html;
        }

        function renderTrueFalse(q) {
            let selected = userAnswers[currentIndex];
            let trueCls = 'tf-btn true';
            let falseCls = 'tf-btn false';
            if (selected === true) trueCls += ' selected';
            if (selected === false) falseCls += ' selected';
            if (quizSubmitted) {
                if (q.correct === true) trueCls += ' correct';
                else if (q.correct === false) falseCls += ' correct';
                if (selected === true && q.correct !== true) trueCls += ' wrong';
                if (selected === false && q.correct !== false) falseCls += ' wrong';
            }
            return `
                <div class="truefalse-container">
                    <div class="${trueCls}" onclick="selectTF(${currentIndex}, true)">âœ… ØµØ­</div>
                    <div class="${falseCls}" onclick="selectTF(${currentIndex}, false)">âŒ Ø®Ø·Ø£</div>
                </div>
            `;
        }

        function renderSyllableSort(q) {
            // Ø¨Ø³ÙŠØ·: Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© Ø¨Ø¯ÙˆÙ† Ø³Ø­Ø¨ Ù…Ø¹Ù‚Ø¯
            return `<p>Ø³Ø¤Ø§Ù„ ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ (Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±)</p>`;
        }

        function renderMatchFirst(q) {
            return `<p>Ø³Ø¤Ø§Ù„ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„ (Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±)</p>`;
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ ==========
        window.selectMCQ = function(qIdx, optIdx) {
            if (quizSubmitted) return;
            userAnswers[qIdx] = optIdx;
            renderQuestion();
        };

        window.selectTF = function(qIdx, value) {
            if (quizSubmitted) return;
            userAnswers[qIdx] = value;
            renderQuestion();
        };

        window.selectMissing = function(qIdx) {
            // ÙÙ‚Ø· Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ØŒ ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø±Ù Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        };

        window.chooseMissing = function(qIdx, letter) {
            if (quizSubmitted) return;
            userAnswers[qIdx] = letter;
            renderQuestion();
        };

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
        let dragSourceIndex = null;

        window.dragStart = function(e, index) {
            if (quizSubmitted) { e.preventDefault(); return; }
            dragSourceIndex = index;
            e.dataTransfer.setData('text/plain', index);
            e.target.classList.add('dragging');
        };

        window.dragOver = function(e, index) {
            e.preventDefault();
            if (quizSubmitted) return;
            e.target.closest('.order-item-row').classList.add('drag-over');
        };

        window.dragLeave = function(e) {
            e.target.closest('.order-item-row').classList.remove('drag-over');
        };

        window.drop = function(e, targetIndex) {
            e.preventDefault();
            e.target.closest('.order-item-row').classList.remove('drag-over');
            if (quizSubmitted || dragSourceIndex === null) return;
            const source = dragSourceIndex;
            if (source === targetIndex) { dragSourceIndex = null; return; }
            const q = questions[currentIndex];
            const currentOrder = [...userAnswers[currentIndex]];
            const [moved] = currentOrder.splice(source, 1);
            currentOrder.splice(targetIndex, 0, moved);
            userAnswers[currentIndex] = currentOrder;
            renderQuestion();
            dragSourceIndex = null;
        };

        window.dragEnd = function(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.order-item-row').forEach(el => el.classList.remove('drag-over'));
            dragSourceIndex = null;
        };

        // Ø§Ù„ØªÙ†Ù‚Ù„
        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0 && !quizSubmitted) {
                currentIndex--;
                renderQuestion();
                updateCounter();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentIndex < questions.length - 1 && !quizSubmitted) {
                currentIndex++;
                renderQuestion();
                updateCounter();
            }
        });

        // ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
        submitBtn.addEventListener('click', () => {
            if (quizSubmitted) return;

            correctCount = 0;
            const wrongDetails = [];

            userAnswers.forEach((ans, idx) => {
                const q = questions[idx];
                if (!q) return;
                let isCorrect = false;
                switch (q.type) {
                    case 'mcq': isCorrect = (ans === q.correct); break;
                    case 'order':
                    case 'sentence_order':
                        if (ans && Array.isArray(ans)) {
                            const correct = q.correctOrder.map(i => q.items ? q.items[i] : q.words[i]);
                            isCorrect = JSON.stringify(ans) === JSON.stringify(correct);
                        }
                        break;
                    case 'missing_letter': isCorrect = (ans === q.options[q.correct]); break;
                    case 'truefalse': isCorrect = (ans === q.correct); break;
                }
                if (isCorrect) correctCount++;
                else {
                    wrongDetails.push({
                        question: q.text,
                        userAnswer: ans,
                        correctAnswer: q.correct
                    });
                }
            });

            const total = questions.length;
            const score = Math.round((correctCount / total) * 100);
            const level = score >= 85 ? 'Ù…ØªÙ‚Ø¯Ù…' : (score >= 65 ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ø¨ØªØ¯Ø¦');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            modalResultScore.textContent = `${score}%`;
            modalResultEmoji.textContent = score >= 85 ? 'ğŸ†' : (score >= 65 ? 'ğŸ‘' : 'ğŸ’ª');
            modalResultMessage.textContent = `Ø£Ø¬Ø¨Øª ØµØ­ÙŠØ­Ø§Ù‹ Ø¹Ù„Ù‰ ${correctCount} Ù…Ù† ${total}`;
            const correctDeg = (correctCount / total) * 360;
            modalPieChart.style.background = `conic-gradient(var(--success) ${correctDeg}deg, var(--border) ${correctDeg}deg)`;
            modalCorrectCount.textContent = correctCount;
            modalWrongCount.textContent = total - correctCount;
            reportSpeed.textContent = speed;
            reportErrors.textContent = errorsCount;
            reportDuration.textContent = duration;

            if (wrongDetails.length > 0) {
                let html = '<h4>âŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h4>';
                wrongDetails.forEach(err => {
                    html += `<div class="error-item"><strong>${escapeHtml(err.question)}</strong><br>Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${escapeHtml(err.userAnswer)} | Ø§Ù„ØµØ­ÙŠØ­: ${escapeHtml(err.correctAnswer)}</div>`;
                });
                errorDetailsContainer.innerHTML = html;
            } else {
                errorDetailsContainer.innerHTML = '<p style="color:var(--success);">ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©.</p>';
            }

            reportModal.classList.add('show');
            quizSubmitted = true;
            renderQuestion();
            submitBtn.disabled = true;
            prevBtn.disabled = true;
            nextBtn.disabled = true;

            saveFinalSession({ correct: correctCount, total, score, level });
        });

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        function closeModal() { reportModal.classList.remove('show'); }
        closeModalBtn.addEventListener('click', closeModal);
        modalCloseBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => { if (e.target === reportModal) closeModal(); });

        function saveFinalSession(quizResult) {
            const sessions = JSON.parse(localStorage.getItem(STORAGE_SESSIONS)) || [];
            const newSession = {
                id: Date.now().toString(),
                lessonId: sessionData.lessonId,
                lessonTitle: sessionData.lessonTitle,
                grade: sessionData.grade,
                semester: sessionData.semester,
                startTime: sessionData.startTime,
                endTime: sessionData.endTime,
                duration: sessionData.duration,
                speed: sessionData.speed,
                errors: sessionData.errors,
                status: 'completed',
                questionsAnswered: quizResult.total,
                questionsCorrect: quizResult.correct,
                comprehensionLevel: quizResult.level
            };
            sessions.push(newSession);
            localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(sessions));
            sessionStorage.removeItem('currentReadingSession');
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/[&<>"]/g, m => {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø±Ø¶
        renderQuestion();
        updateCounter();
    })();
</script>
</body>
</html>
