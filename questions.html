<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙÙ‡Ù… Â· ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Ø£Ù†Ù…Ø§Ø· Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø«ÙŠÙ…Ø§Øª */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI','Cairo',Tahoma,sans-serif; }

        :root {
            --bg: #f4f7fb;
            --card-bg: #ffffff;
            --text: #1e2b3c;
            --text-light: #64748b;
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #e9eef2;
            --shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --text: #e9eef2;
            --text-light: #a0aec0;
            --border: #2d3748;
            --shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        [data-theme="comfort"] {
            --bg: #e6d5b8;
            --card-bg: #faf0e6;
            --text: #5e4b3c;
            --text-light: #7d6b5a;
            --border: #d4b89c;
            --shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        body {
            background: var(--bg);
            color: var(--text);
            padding: 20px;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        .header {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 15px 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .btn-home {
            background: transparent;
            color: var(--text);
            border: 2px solid var(--border);
            padding: 8px 16px;
            border-radius: 40px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-home:hover { background: var(--border); }

        .timer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary);
            color: white;
            padding: 8px 20px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */
        .reading-info-bar {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .reading-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
            margin-bottom: 15px;
        }

        .stat-badge {
            background: var(--bg);
            border-radius: 40px;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .stat-badge i { color: var(--primary); }
        .stat-badge .value { color: var(--primary); margin-left: 5px; }

        .result-card {
            background: var(--card-bg);
            border-radius: 40px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        .lesson-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            background: var(--bg);
            border-radius: 30px;
            padding: 20px;
            margin: 15px 0;
        }

        .meta-item { text-align: center; }
        .meta-label { color: var(--text-light); font-size: 0.85rem; }
        .meta-value { font-weight: 700; font-size: 1.2rem; color: var(--primary); }

        .comprehension-level {
            background: linear-gradient(135deg, var(--primary), var(--success));
            color: white;
            border-radius: 50px;
            padding: 15px 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
            margin: 15px 0;
        }

        .progress-chart {
            display: flex;
            align-items: center;
            gap: 20px;
            background: var(--bg);
            border-radius: 30px;
            padding: 15px;
            margin-top: 15px;
            justify-content: center;
        }

        .pie {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(var(--success) 0deg, var(--border) 0deg);
            transition: background 0.5s;
        }

        .legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: right;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot-success { background: var(--success); }
        .dot-border { background: var(--border); }

        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-counter {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        .question-box {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .option {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 40px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
        }
        .option:hover { border-color: var(--primary); background: color-mix(in srgb, var(--primary) 5%, var(--bg)); }
        .option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .option.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .option.wrong {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* ===== Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…) ===== */
        .order-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .order-item-row {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg);
            border-radius: 60px;
            padding: 12px 20px;
            border: 1px solid var(--border);
        }

        .order-item-text {
            flex: 1;
            font-size: 1.1rem;
        }

        .number-circles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .number-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            cursor: pointer;
            transition: 0.2s;
        }
        .number-circle:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        .number-circle.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .number-circle.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .nav-btn:hover:not(:disabled) { background: var(--primary); color: white; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .submit-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 40px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: 0.2s;
        }
        .submit-btn:hover { transform: scale(1.02); box-shadow: 0 10px 20px rgba(16,185,129,0.3); }
        .submit-btn:disabled { background: var(--border); cursor: not-allowed; transform: none; box-shadow: none; }

        .result-summary { display: none; }

        .no-questions {
            background: var(--card-bg);
            border-radius: 40px;
            padding: 50px;
            text-align: center;
            color: var(--text-light);
            border: 1px solid var(--border);
        }

        .hidden { display: none; }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø³Ù† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            position: relative;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .close-modal {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
        }
        .close-modal:hover {
            color: var(--danger);
        }
        .modal-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 40px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px 0;
            transition: 0.2s;
        }
        .modal-btn:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
            border-radius: 30px;
            padding: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .report-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .error-details {
            text-align: right;
            margin: 15px 0;
        }

        .error-item {
            background: var(--bg);
            border-radius: 20px;
            padding: 12px;
            margin-bottom: 8px;
            border-right: 5px solid var(--danger);
        }

        .error-question {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .error-answers {
            font-size: 0.9rem;
            color: var(--text-light);
            display: flex;
            gap: 15px;
        }
    </style>
</head>
<body data-theme="light">
<div class="container">
    <div class="header">
        <div class="logo">
            <i class="fas fa-question-circle"></i>
            <span>Ø§Ø®ØªØ¨Ø± ÙÙ‡Ù…Ùƒ</span>
        </div>
        <a href="index.html" class="btn-home"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <div class="timer-container" id="timerDisplay">
            <i class="fas fa-hourglass-half"></i>
            <span id="timerValue">60</span> Ø«
        </div>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹) -->
    <div class="reading-info-bar" id="readingInfoBar"></div>

    <div id="resultCard" class="result-card hidden">
        <h2 class="lesson-title" id="lessonTitle"></h2>
        <div class="meta-grid" id="metaContainer"></div>
        <div class="comprehension-level" id="comprehensionLevel">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙÙ‡Ù…: --</div>
        <div class="progress-chart" id="progressChart">
            <div class="pie" id="pieChart"></div>
            <div class="legend">
                <div class="legend-item"><span class="color-dot dot-success"></span> <span id="correctCount">0</span> Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                <div class="legend-item"><span class="color-dot dot-border"></span> <span id="wrongCount">0</span> Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
            </div>
        </div>
    </div>

    <div id="questionsSection">
        <div class="questions-header">
            <h3><i class="fas fa-pencil-alt"></i> Ø£Ø¬Ø¨ Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
            <span class="question-counter" id="questionCounter">1 / 0</span>
        </div>
        <div id="questionContainer" class="question-box"></div>
        <div class="navigation-buttons">
            <button class="nav-btn" id="prevBtn" disabled><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="nav-btn" id="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
        </div>
        <button class="submit-btn" id="submitBtn" disabled>Ø³Ù„Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø³Ù† -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModalBtn">&times;</span>
            <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„</h2>
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© -->
            <div class="report-header">
                <div class="report-stat"><i class="fas fa-tachometer-alt"></i> Ø§Ù„Ø³Ø±Ø¹Ø©: <span id="reportSpeed">0</span> Ùƒ/Ø¯</div>
                <div class="report-stat"><i class="fas fa-exclamation-triangle" style="color:var(--danger);"></i> Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <span id="reportErrors">0</span></div>
                <div class="report-stat"><i class="fas fa-clock"></i> Ø§Ù„Ø²Ù…Ù†: <span id="reportDuration">00:00</span></div>
            </div>
            
            <div class="result-emoji" id="modalResultEmoji">ğŸ†</div>
            <div class="result-score" id="modalResultScore">0%</div>
            <div class="result-message" id="modalResultMessage"></div>
            
            <div class="progress-chart">
                <div class="pie" id="modalPieChart"></div>
                <div class="legend">
                    <div class="legend-item"><span class="color-dot dot-success"></span> <span id="modalCorrectCount">0</span> Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                    <div class="legend-item"><span class="color-dot dot-border"></span> <span id="modalWrongCount">0</span> Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                </div>
            </div>

            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ -->
            <div id="errorDetailsContainer" class="error-details"></div>

            <button class="modal-btn" id="modalCloseBtn">Ø¥ØºÙ„Ø§Ù‚</button>
            <a href="index.html" class="btn-home" style="display: inline-block; margin-top: 10px;"><i class="fas fa-book"></i> Ø§Ù‚Ø±Ø£ Ù†ØµØ§Ù‹ Ø¢Ø®Ø±</a>
        </div>
    </div>
</div>

<script>
    (function() {
        const STORAGE_SESSIONS = 'reading_sessions';
        const sessionData = JSON.parse(sessionStorage.getItem('currentReadingSession'));

        if (!sessionData) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù„Ø³Ø© Ù‚Ø±Ø§Ø¡Ø©ØŒ Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
            window.location.href = 'index.html';
            return;
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const lessonTitle = sessionData.lessonTitle;
        const grade = sessionData.grade;
        const semester = sessionData.semester;
        const totalWords = sessionData.totalWords;
        const duration = sessionData.duration;
        const speed = sessionData.speed;
        const errorsCount = sessionData.errors || 0;
        const allQuestions = sessionData.questions || [];

        // Ø¹Ù†Ø§ØµØ± DOM
        const readingInfoBar = document.getElementById('readingInfoBar');
        const resultCard = document.getElementById('resultCard');
        const questionsSection = document.getElementById('questionsSection');
        const lessonTitleEl = document.getElementById('lessonTitle');
        const metaContainer = document.getElementById('metaContainer');
        const comprehensionLevel = document.getElementById('comprehensionLevel');
        const pieChart = document.getElementById('pieChart');
        const correctSpan = document.getElementById('correctCount');
        const wrongSpan = document.getElementById('wrongCount');
        const questionContainer = document.getElementById('questionContainer');
        const questionCounter = document.getElementById('questionCounter');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerValue = document.getElementById('timerValue');

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        const reportModal = document.getElementById('reportModal');
        const modalResultEmoji = document.getElementById('modalResultEmoji');
        const modalResultScore = document.getElementById('modalResultScore');
        const modalResultMessage = document.getElementById('modalResultMessage');
        const modalPieChart = document.getElementById('modalPieChart');
        const modalCorrectCount = document.getElementById('modalCorrectCount');
        const modalWrongCount = document.getElementById('modalWrongCount');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const reportSpeed = document.getElementById('reportSpeed');
        const reportErrors = document.getElementById('reportErrors');
        const reportDuration = document.getElementById('reportDuration');
        const errorDetailsContainer = document.getElementById('errorDetailsContainer');

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ…
        if (sessionData.theme) {
            document.body.setAttribute('data-theme', sessionData.theme);
        } else {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
        readingInfoBar.innerHTML = `
            <div class="reading-stats">
                <div class="stat-badge"><i class="fas fa-book"></i> Ø§Ù„Ù†Øµ: <span class="value">${escapeHtml(lessonTitle)}</span></div>
                <div class="stat-badge"><i class="fas fa-tachometer-alt"></i> Ø§Ù„Ø³Ø±Ø¹Ø©: <span class="value">${speed}</span> Ùƒ/Ø¯</div>
                <div class="stat-badge"><i class="fas fa-exclamation-circle" style="color:var(--danger);"></i> Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: <span class="value" style="color:var(--danger);">${errorsCount}</span></div>
                <div class="stat-badge"><i class="fas fa-clock"></i> Ø§Ù„Ø²Ù…Ù†: <span class="value">${formatTime(duration)}</span></div>
            </div>
        `;

        // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª)
        lessonTitleEl.textContent = lessonTitle;
        metaContainer.innerHTML = `
            <div class="meta-item"><div class="meta-label">Ø§Ù„ØµÙ</div><div class="meta-value">${escapeHtml(grade)}</div></div>
            <div class="meta-item"><div class="meta-label">Ø§Ù„ÙØµÙ„</div><div class="meta-value">${escapeHtml(semester)}</div></div>
            <div class="meta-item"><div class="meta-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</div><div class="meta-value">${totalWords}</div></div>
            <div class="meta-item"><div class="meta-label">Ø²Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</div><div class="meta-value">${formatTime(duration)}</div></div>
            <div class="meta-item"><div class="meta-label">Ø§Ù„Ø³Ø±Ø¹Ø©</div><div class="meta-value">${speed} Ùƒ/Ø¯</div></div>
            <div class="meta-item"><div class="meta-label">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div><div class="meta-value" style="color:var(--danger);">${errorsCount}</div></div>
        `;

        if (!allQuestions || allQuestions.length === 0) {
            questionsSection.innerHTML = '<div class="no-questions"><i class="fas fa-smile-wink fa-4x"></i><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ</h3><p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p></div>';
            resultCard.classList.remove('hidden');
            comprehensionLevel.textContent = `Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙÙ‡Ù…: Ù…ÙƒØªÙ…Ù„ (Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø¦Ù„Ø©)`;
            pieChart.style.background = `conic-gradient(var(--success) 360deg, var(--border) 0deg)`;
            correctSpan.textContent = '0';
            wrongSpan.textContent = '0';
            timerDisplay.style.display = 'none';
            saveFinalSession(null);
            return;
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
        function validateQuestion(q) {
            if (!q) return false;
            if (q.type === 'order') {
                return q.events && Array.isArray(q.events) && q.events.length > 0 && q.correctOrder && Array.isArray(q.correctOrder);
            } else {
                return q.options && Array.isArray(q.options) && q.options.length > 0 && q.correct !== undefined;
            }
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
        const validQuestions = allQuestions.filter(q => validateQuestion(q));
        if (validQuestions.length === 0) {
            questionsSection.innerHTML = '<div class="no-questions"><i class="fas fa-exclamation-triangle fa-4x"></i><h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ø£Ùˆ Ù†Ø§Ù‚ØµØ©</h3><p>ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p></div>';
            return;
        }

        // ========== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ==========
        function selectQuestions(questionsArray, count = 10) {
            if (!Array.isArray(questionsArray) || questionsArray.length === 0) return [];

            const questionsCopy = [...questionsArray];
            const orderQuestions = questionsCopy.filter(q => q.type === 'order');
            const otherQuestions = questionsCopy.filter(q => q.type !== 'order');

            let selected = [];

            if (orderQuestions.length > 0) {
                const randomOrderIndex = Math.floor(Math.random() * orderQuestions.length);
                const selectedOrder = orderQuestions[randomOrderIndex];
                
                let availableOthers = [...otherQuestions];
                for (let i = availableOthers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableOthers[i], availableOthers[j]] = [availableOthers[j], availableOthers[i]];
                }
                
                let othersSelected = [];
                for (let i = 0; i < count - 1; i++) {
                    if (availableOthers.length > 0) {
                        othersSelected.push(availableOthers.shift());
                    } else {
                        availableOthers = [...otherQuestions];
                        for (let i = availableOthers.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [availableOthers[i], availableOthers[j]] = [availableOthers[j], availableOthers[i]];
                        }
                        if (availableOthers.length > 0) othersSelected.push(availableOthers.shift());
                    }
                }
                selected = [...othersSelected, selectedOrder];
            } else {
                let availableAll = [...questionsCopy];
                for (let i = availableAll.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableAll[i], availableAll[j]] = [availableAll[j], availableAll[i]];
                }
                for (let i = 0; i < count; i++) {
                    if (availableAll.length > 0) selected.push(availableAll.shift());
                    else {
                        availableAll = [...questionsCopy];
                        for (let i = availableAll.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [availableAll[i], availableAll[j]] = [availableAll[j], availableAll[i]];
                        }
                        if (availableAll.length > 0) selected.push(availableAll.shift());
                    }
                }
            }

            selected = selected.filter(q => q !== undefined && q !== null);

            // ÙˆØ¶Ø¹ Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            const orderIndex = selected.findIndex(q => q.type === 'order');
            if (orderIndex !== -1 && orderIndex !== selected.length - 1) {
                const orderQ = selected.splice(orderIndex, 1)[0];
                selected.push(orderQ);
            }

            return selected;
        }

        let questions = selectQuestions(validQuestions, 10);
        if (questions.length < 10 && questions.length > 0) {
            const needed = 10 - questions.length;
            for (let i = 0; i < needed; i++) {
                const randomIndex = Math.floor(Math.random() * questions.length);
                questions.push({...questions[randomIndex]});
            }
        }

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
        let currentQuestionIndex = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let quizSubmitted = false;
        let correctAnswersCount = 0;

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚Øª
        let timerInterval = null;
        let timeLeft = 0;
        const DEFAULT_TIME = 60;
        const ORDER_TIME = 100;

        function startTimerForCurrentQuestion() {
            if (timerInterval) clearInterval(timerInterval);
            if (quizSubmitted) return;
            if (!questions[currentQuestionIndex]) return;

            const q = questions[currentQuestionIndex];
            timeLeft = (q.type === 'order') ? ORDER_TIME : DEFAULT_TIME;
            timerValue.textContent = timeLeft;

            timerInterval = setInterval(() => {
                timeLeft -= 1;
                timerValue.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    if (quizSubmitted) return;

                    if (currentQuestionIndex === questions.length - 1) {
                        submitAnswers();
                    } else {
                        goToNextQuestion();
                    }
                }
            }, 1000);
        }

        function goToNextQuestion() {
            if (currentQuestionIndex < questions.length - 1 && !quizSubmitted) {
                if (timerInterval) clearInterval(timerInterval);
                currentQuestionIndex++;
                renderQuestion();
                updateCounter();
                startTimerForCurrentQuestion();
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
        function submitAnswers() {
            if (quizSubmitted) return;

            correctAnswersCount = 0;
            const wrongDetails = []; // Ù„ØªØ®Ø²ÙŠÙ† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡

            userAnswers.forEach((ans, idx) => {
                const q = questions[idx];
                if (!q) return;
                let isCorrect = false;
                if (q.type === 'order') {
                    if (ans && Array.isArray(ans)) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ans Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±)
                        // Ù†Ù‚Ø§Ø±Ù† Ù…Ø¹ q.correctOrder (Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªÙ…Ø«Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­)
                        const correctOrder = q.correctOrder; // [0,1,2,3,4] Ù…Ø«Ù„Ø§Ù‹
                        if (JSON.stringify(ans) === JSON.stringify(correctOrder)) {
                            isCorrect = true;
                        }
                    }
                } else {
                    if (ans === q.correct) isCorrect = true;
                }
                if (isCorrect) correctAnswersCount++;
                else {
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
                    wrongDetails.push({
                        question: q.text || `Ø³Ø¤Ø§Ù„ ${idx+1}`,
                        userAnswer: ans,
                        correctAnswer: q.type === 'order' ? (q.correctOrder ? q.correctOrder.map(i => q.events[i]).join(' â†’ ') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : (q.options ? q.options[q.correct] : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
                        type: q.type
                    });
                }
            });

            const score = Math.round((correctAnswersCount / questions.length) * 100);
            let level = '';
            if (score >= 85) level = 'Ù…ØªÙ‚Ø¯Ù…';
            else if (score >= 65) level = 'Ù…ØªÙˆØ³Ø·';
            else level = 'Ù…Ø¨ØªØ¯Ø¦';

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            modalResultScore.textContent = `${score}%`;
            let emoji = score >= 85 ? 'ğŸ†' : (score >= 65 ? 'ğŸ‘' : 'ğŸ’ª');
            modalResultEmoji.textContent = emoji;
            modalResultMessage.textContent = `Ø£Ø¬Ø¨Øª ØµØ­ÙŠØ­Ø§Ù‹ Ø¹Ù„Ù‰ ${correctAnswersCount} Ù…Ù† ${questions.length}`;
            
            const wrongCount = questions.length - correctAnswersCount;
            const correctDeg = (correctAnswersCount / questions.length) * 360;
            modalPieChart.style.background = `conic-gradient(var(--success) ${correctDeg}deg, var(--border) ${correctDeg}deg)`;
            modalCorrectCount.textContent = correctAnswersCount;
            modalWrongCount.textContent = wrongCount;

            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            reportSpeed.textContent = speed;
            reportErrors.textContent = errorsCount;
            reportDuration.textContent = formatTime(duration);

            // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            if (wrongDetails.length > 0) {
                let errorHtml = '<h4>âŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h4>';
                wrongDetails.forEach((err, i) => {
                    errorHtml += `
                        <div class="error-item">
                            <div class="error-question">${escapeHtml(err.question)}</div>
                            <div class="error-answers">
                                <span style="color:var(--danger);">Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${escapeHtml(Array.isArray(err.userAnswer) ? err.userAnswer.map(a=>a+1).join(' â†’ ') : (err.userAnswer !== null ? err.userAnswer+1 : 'Ù„Ù… ØªØ¬Ø¨'))}</span>
                                <span style="color:var(--success);">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${escapeHtml(err.correctAnswer)}</span>
                            </div>
                        </div>
                    `;
                });
                errorDetailsContainer.innerHTML = errorHtml;
            } else {
                errorDetailsContainer.innerHTML = '<p style="color:var(--success);">ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡! Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ ÙƒÙ„Ù‡Ø§ ØµØ­ÙŠØ­Ø©.</p>';
            }

            reportModal.classList.add('show');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
            resultCard.classList.add('hidden'); // Ù†Ø®ÙÙŠÙ‡Ø§ Ù„Ø£Ù†Ù†Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
            comprehensionLevel.textContent = `Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙÙ‡Ù…: ${level} (${score}%)`;
            pieChart.style.background = `conic-gradient(var(--success) ${correctDeg}deg, var(--border) ${correctDeg}deg)`;
            correctSpan.textContent = correctAnswersCount;
            wrongSpan.textContent = wrongCount;

            quizSubmitted = true;
            if (timerInterval) clearInterval(timerInterval);
            timerDisplay.style.display = 'none';

            renderQuestion();
            submitBtn.disabled = true;
            prevBtn.disabled = true;
            nextBtn.disabled = true;

            saveFinalSession({ correct: correctAnswersCount, total: questions.length, score, level });
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        function closeModal() {
            reportModal.classList.remove('show');
        }

        closeModalBtn.addEventListener('click', closeModal);
        modalCloseBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === reportModal) closeModal();
        });

        function updateCounter() {
            questionCounter.textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ (Ù…Ø¹Ø¯Ù„Ø© Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        function renderQuestion() {
            const q = questions[currentQuestionIndex];
            if (!q) {
                questionContainer.innerHTML = `<div class="question-text">Ø®Ø·Ø£: Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±</div>`;
                return;
            }

            let html = `<div class="question-text">${currentQuestionIndex + 1}. ${escapeHtml(q.text || '')}</div>`;

            if (q.type === 'order') {
                const events = q.events || [];
                if (events.length === 0) {
                    html += `<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§</p>`;
                } else {
                    let currentOrder = userAnswers[currentQuestionIndex];
                    if (!currentOrder) {
                        // ØªÙ‡ÙŠØ¦Ø© Ø¥ÙØªØ±Ø§Ø¶ÙŠØ©: null Ù„ÙƒÙ„ Ø¹Ù†ØµØ±
                        currentOrder = new Array(events.length).fill(null);
                        userAnswers[currentQuestionIndex] = currentOrder;
                    }

                    html += `<div class="order-container" id="order-${currentQuestionIndex}">`;
                    events.forEach((eventText, idx) => {
                        const selectedNum = currentOrder[idx];
                        html += `
                            <div class="order-item-row">
                                <span class="order-item-text">${escapeHtml(eventText)}</span>
                                <div class="number-circles">`;
                        for (let num = 1; num <= events.length; num++) {
                            const isSelected = (selectedNum === num);
                            const disabled = quizSubmitted;
                            html += `<span class="number-circle ${isSelected ? 'selected' : ''} ${disabled ? 'disabled' : ''}" data-event-idx="${idx}" data-num="${num}" onclick="selectOrderNumber(${currentQuestionIndex}, ${idx}, ${num})">${num}</span>`;
                        }
                        html += `</div></div>`;
                    });
                    html += `</div>`;
                }
            } else {
                const options = q.options || [];
                if (options.length === 0) {
                    html += `<p class="error-message">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø´Ø±Ù.</p>`;
                } else {
                    let optionsHtml = '';
                    options.forEach((opt, idx) => {
                        let optionClass = 'option';
                        if (userAnswers[currentQuestionIndex] === idx) optionClass += ' selected';
                        if (quizSubmitted) {
                            if (idx === q.correct) optionClass += ' correct';
                            else if (userAnswers[currentQuestionIndex] === idx && idx !== q.correct) optionClass += ' wrong';
                        }
                        const onClick = quizSubmitted ? '' : `selectAnswer(${currentQuestionIndex}, ${idx})`;
                        optionsHtml += `<div class="${optionClass}" data-opt="${idx}" onclick="${onClick}">${escapeHtml(opt)}</div>`;
                    });
                    html += `<div class="options-grid">${optionsHtml}</div>`;
                }
            }

            questionContainer.innerHTML = html;

            prevBtn.disabled = (currentQuestionIndex === 0) || quizSubmitted;
            nextBtn.disabled = (currentQuestionIndex === questions.length - 1) || quizSubmitted;

            const allAnswered = userAnswers.every(ans => {
                if (Array.isArray(ans)) {
                    return ans.every(val => val !== null); // ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ù‡Ø§ Ù‚ÙŠÙ…Ø©
                }
                return ans !== null;
            });
            submitBtn.disabled = !allAnswered || quizSubmitted;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… ÙÙŠ Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨
        window.selectOrderNumber = function(qIdx, eventIdx, num) {
            if (quizSubmitted) return;
            const q = questions[qIdx];
            if (!q || q.type !== 'order') return;

            const currentOrder = [...userAnswers[qIdx]]; // Ù†Ø³Ø®Ø©

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…Ø­Ø¯Ø¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù†ØµØ±ØŒ Ù†Ù„ØºÙŠÙ‡
            if (currentOrder[eventIdx] === num) {
                currentOrder[eventIdx] = null;
            } else {
                // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¹Ù†ØµØ± Ø¢Ø®Ø±
                const numAlreadyUsed = currentOrder.includes(num);
                if (numAlreadyUsed) {
                    alert('Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¹Ù†ØµØ± Ø¢Ø®Ø±. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ù…Ø®ØªÙ„Ù.');
                    return;
                }
                currentOrder[eventIdx] = num;
            }

            userAnswers[qIdx] = currentOrder;
            renderQuestion(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        };

        // Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ø§Ø¯ÙŠØ©
        window.selectAnswer = function(qIdx, optIdx) {
            if (quizSubmitted) return;
            userAnswers[qIdx] = optIdx;
            renderQuestion();
        };

        // Ø§Ù„ØªÙ†Ù‚Ù„
        prevBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0 && !quizSubmitted) {
                if (timerInterval) clearInterval(timerInterval);
                currentQuestionIndex--;
                renderQuestion();
                updateCounter();
                startTimerForCurrentQuestion();
            }
        });

        nextBtn.addEventListener('click', () => {
            goToNextQuestion();
        });

        submitBtn.addEventListener('click', () => {
            submitAnswers();
        });

        function saveFinalSession(quizResult) {
            const sessions = JSON.parse(localStorage.getItem(STORAGE_SESSIONS)) || [];
            const newSession = {
                id: Date.now().toString(),
                lessonId: sessionData.lessonId,
                lessonTitle: sessionData.lessonTitle,
                grade: sessionData.grade,
                semester: sessionData.semester,
                startTime: sessionData.startTime,
                endTime: sessionData.endTime,
                duration: sessionData.duration,
                speed: sessionData.speed,
                wordsRead: sessionData.totalWords,
                totalWords: sessionData.totalWords,
                errors: sessionData.errors,
                status: 'completed',
                questionsAnswered: quizResult ? quizResult.total : 0,
                questionsCorrect: quizResult ? quizResult.correct : 0,
                comprehensionLevel: quizResult ? quizResult.level : ''
            };
            sessions.push(newSession);
            localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(sessions));
            sessionStorage.removeItem('currentReadingSession');
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø±Ø¶
        renderQuestion();
        updateCounter();
        startTimerForCurrentQuestion();
    })();
</script>
</body>
</html>
