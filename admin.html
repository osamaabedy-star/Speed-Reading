<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المحتوى الاحترافي - القراءة السريعة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #2b2d42;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Cairo', Tahoma, sans-serif; }

        body { background: var(--bg); color: var(--text); padding: 20px; line-height: 1.6; }

        .container { max-width: 1100px; margin: 0 auto; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .logo { display: flex; align-items: center; gap: 15px; color: var(--primary); }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }

        .main-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; }

        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .card { background: var(--card-bg); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

        .card-title { font-size: 1.3rem; margin-bottom: 20px; color: var(--secondary); border-bottom: 2px solid var(--bg); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        input, textarea, select {
            width: 100%; padding: 12px 15px; border: 2px solid #edf2f7; border-radius: 12px; font-size: 1rem; transition: 0.3s;
        }

        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        .btn { padding: 12px 25px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }
        .btn-secondary { background: #f1f5f9; color: var(--text); }
        .btn-secondary:hover { background: #e2e8f0; }

        .question-item {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            position: relative;
            border-right: 4px solid var(--primary);
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .question-type {
            width: 150px;
        }
        .remove-question {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .option-input {
            width: 100%;
        }
        .correct-select {
            margin-top: 10px;
            width: 200px;
        }

        .lesson-card {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-radius: 15px; border: 1px solid #edf2f7; margin-bottom: 10px; background: white;
        }

        .actions { display: flex; gap: 10px; }
        .btn-icon { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: 0.2s; }
        .edit-btn { background: #e0e7ff; color: var(--primary); }
        .delete-btn { background: #ffe4e6; color: var(--danger); }

        .password-change {
            margin-top: 20px;
            text-align: left;
        }
        .small-btn {
            background: transparent;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">
            <i class="fas fa-user-shield fa-2x"></i>
            <div>
                <h1>لوحة التحكم</h1>
                <p style="font-size: 0.8rem; color: #64748b;">تحديث وإدارة محتوى القراءة</p>
            </div>
        </div>
        <div class="actions">
            <button class="btn btn-primary" onclick="location.href='index.html'"><i class="fas fa-home"></i> المتجر</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <i class="fas fa-book-open" style="color: var(--primary)"></i>
            <div><h4 id="count-lessons">0</h4><p>نصوص</p></div>
        </div>
        <div class="stat-card">
            <i class="fas fa-question-circle" style="color: var(--success)"></i>
            <div><h4 id="count-questions">0</h4><p>أسئلة</p></div>
        </div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h3 class="card-title"><i class="fas fa-pen"></i> إضافة نص جديد</h3>
            <form id="lessonForm">
                <div class="form-group">
                    <label>عنوان النص</label>
                    <input type="text" id="lessonTitle" required placeholder="أدخل العنوان...">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>الصف</label>
                        <select id="lessonGrade">
                            <option value="الأول الابتدائي">الأول الابتدائي</option>
                            <option value="الثاني الابتدائي">الثاني الابتدائي</option>
                            <option value="الثالث الابتدائي">الثالث الابتدائي</option>
                            <option value="الرابع الابتدائي">الرابع الابتدائي</option>
                            <option value="الخامس الابتدائي">الخامس الابتدائي</option>
                            <option value="السادس الابتدائي">السادس الابتدائي</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>الفصل</label>
                        <select id="lessonSemester">
                            <option value="1">الأول</option>
                            <option value="2">الثاني</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>محتوى النص</label>
                    <textarea id="lessonContent" rows="6" required placeholder="الصق النص هنا..."></textarea>
                </div>

                <div id="questionsContainer">
                    <label style="margin-top: 20px;">الأسئلة</label>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button type="button" class="btn btn-secondary" id="addMcqBtn">
                        <i class="fas fa-plus-circle"></i> إضافة سؤال اختيار من متعدد
                    </button>
                    <button type="button" class="btn btn-secondary" id="addTrueFalseBtn">
                        <i class="fas fa-plus-circle"></i> إضافة سؤال صح/خطأ
                    </button>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 2;">حفظ التغييرات</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()" style="flex: 1;">إلغاء</button>
                </div>
            </form>
            <div class="password-change">
                <button class="small-btn" onclick="changePassword()"><i class="fas fa-key"></i> تغيير كلمة المرور</button>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title"><i class="fas fa-list-ul"></i> المحتوى الحالي</h3>
            <div id="lessonsList"></div>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'reading_app_lessons';
    const ADMIN_AUTH_KEY = 'admin_auth';
    const DEFAULT_PASSWORD = 'admin';
    let editingId = null;

    async function hashString(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function checkAuth() {
        const defaultHash = await hashString(DEFAULT_PASSWORD);
        const customHash = localStorage.getItem('admin_custom_hash');
        const storedHash = customHash || defaultHash;
        
        let authHash = sessionStorage.getItem(ADMIN_AUTH_KEY);
        if (authHash === storedHash) return true;

        const pass = prompt("كلمة مرور الإدارة:");
        if (pass) {
            const inputHash = await hashString(pass);
            if (inputHash === storedHash) {
                sessionStorage.setItem(ADMIN_AUTH_KEY, inputHash);
                return true;
            } else {
                alert("كلمة مرور خاطئة!");
                window.location.href = 'index.html';
                return false;
            }
        } else {
            window.location.href = 'index.html';
            return false;
        }
    }

    window.changePassword = async function() {
        const newPass = prompt("أدخل كلمة المرور الجديدة:");
        if (!newPass) return;
        const confirmPass = prompt("تأكيد كلمة المرور الجديدة:");
        if (newPass !== confirmPass) {
            alert("كلمة المرور غير متطابقة!");
            return;
        }
        const newHash = await hashString(newPass);
        localStorage.setItem('admin_custom_hash', newHash);
        alert("تم تغيير كلمة المرور. سيتم استخدامها من الآن.");
        sessionStorage.setItem(ADMIN_AUTH_KEY, newHash);
    };

    (async function() {
        const authorized = await checkAuth();
        if (authorized) {
            init();
        }
    })();

    function init() {
        renderLessons();
        document.getElementById('lessonForm').addEventListener('submit', saveLesson);
        document.getElementById('addMcqBtn').addEventListener('click', () => addQuestionField('mcq'));
        document.getElementById('addTrueFalseBtn').addEventListener('click', () => addQuestionField('truefalse'));
    }

    function getLessons() { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }

    function renderLessons() {
        const lessons = getLessons();
        const list = document.getElementById('lessonsList');
        const countL = document.getElementById('count-lessons');
        const countQ = document.getElementById('count-questions');
        
        countL.innerText = lessons.length;
        let qTotal = 0;

        list.innerHTML = lessons.map(l => {
            qTotal += (l.questions?.length || 0);
            return `
                <div class="lesson-card" data-id="${l.id}">
                    <div>
                        <strong>${escapeHtml(l.title)}</strong><br>
                        <small style="color:#666">${escapeHtml(l.grade)} - ${l.questions?.length || 0} سؤال</small>
                    </div>
                    <div class="actions">
                        <button class="btn-icon edit-btn" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete-btn" title="حذف"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('') || '<p style="text-align:center; color:#999;">لا يوجد محتوى مضاف.</p>';

        countQ.innerText = qTotal;

        document.querySelectorAll('.lesson-card').forEach(card => {
            const id = card.dataset.id;
            card.querySelector('.edit-btn').addEventListener('click', () => editLesson(id));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteLesson(id));
        });
    }

    function addQuestionField(type = 'mcq', data = null) {
        const container = document.getElementById('questionsContainer');
        const div = document.createElement('div');
        div.className = 'question-item';
        
        let optionsHtml = '';
        let correctOptions = '';
        
        if (type === 'mcq' || data?.type === 'mcq') {
            // اختيار من متعدد (4 خيارات)
            for (let i = 0; i < 4; i++) {
                optionsHtml += `<input type="text" class="option-input" placeholder="خيار ${i+1}" value="${escapeHtml(data?.options?.[i] || '')}">`;
            }
            correctOptions = `
                <select class="correct-select">
                    <option value="">اختر الإجابة الصحيحة</option>
                    ${[0,1,2,3].map(i => `<option value="${i}" ${data?.correct == i ? 'selected' : ''}>خيار ${i+1}</option>`).join('')}
                </select>
            `;
        } else {
            // صح/خطأ (خياران)
            optionsHtml = `
                <input type="text" class="option-input" placeholder="الإجابة الصحيحة (مثال: صح)" value="${escapeHtml(data?.options?.[0] || 'صح')}">
                <input type="text" class="option-input" placeholder="الإجابة الخاطئة (مثال: خطأ)" value="${escapeHtml(data?.options?.[1] || 'خطأ')}">
            `;
            correctOptions = `
                <select class="correct-select">
                    <option value="">اختر الإجابة الصحيحة</option>
                    <option value="0" ${data?.correct == 0 ? 'selected' : ''}>الخيار الأول (صح)</option>
                    <option value="1" ${data?.correct == 1 ? 'selected' : ''}>الخيار الثاني (خطأ)</option>
                </select>
            `;
        }

        div.innerHTML = `
            <div class="question-header">
                <select class="question-type" onchange="changeQuestionType(this)">
                    <option value="mcq" ${(type === 'mcq' || data?.type === 'mcq') ? 'selected' : ''}>اختيار من متعدد</option>
                    <option value="truefalse" ${(type === 'truefalse' || data?.type === 'truefalse') ? 'selected' : ''}>صح/خطأ</option>
                </select>
                <button type="button" class="remove-question" title="حذف السؤال"><i class="fas fa-times"></i></button>
            </div>
            <input type="text" class="q-text" placeholder="نص السؤال" value="${escapeHtml(data?.text || '')}" style="width:100%; margin-bottom:10px;">
            <div class="options-container">
                ${optionsHtml}
            </div>
            ${correctOptions}
            <input type="hidden" class="q-type" value="${type}">
        `;

        div.querySelector('.remove-question').addEventListener('click', () => div.remove());
        div.querySelector('.question-type').addEventListener('change', function(e) {
            changeQuestionType(e.target);
        });
        container.appendChild(div);
    }

    window.changeQuestionType = function(selectEl) {
        const questionItem = selectEl.closest('.question-item');
        const newType = selectEl.value;
        const oldType = questionItem.querySelector('.q-type')?.value || 'mcq';
        if (newType === oldType) return;
        
        // استخراج البيانات الحالية إن وجدت
        const text = questionItem.querySelector('.q-text')?.value || '';
        let options = [];
        if (oldType === 'mcq') {
            options = Array.from(questionItem.querySelectorAll('.option-input')).map(i => i.value);
        } else {
            options = Array.from(questionItem.querySelectorAll('.option-input')).map(i => i.value);
        }
        const correct = questionItem.querySelector('.correct-select')?.value;
        
        // إعادة بناء السؤال بالنوع الجديد
        const type = newType;
        questionItem.remove();
        addQuestionField(type, { text, options, correct: correct ? parseInt(correct) : null, type });
    };

    function saveLesson(e) {
        e.preventDefault();

        const title = document.getElementById('lessonTitle').value.trim();
        const grade = document.getElementById('lessonGrade').value;
        const semester = document.getElementById('lessonSemester').value;
        const content = document.getElementById('lessonContent').value.trim();

        if (!title || !content) {
            alert('الرجاء إدخال عنوان ومحتوى النص');
            return;
        }

        const questionItems = document.querySelectorAll('.question-item');
        const questions = [];
        for (let item of questionItems) {
            const text = item.querySelector('.q-text')?.value.trim();
            const options = Array.from(item.querySelectorAll('.option-input')).map(i => i.value.trim());
            const correct = item.querySelector('.correct-select')?.value;
            const type = item.querySelector('.question-type')?.value || 'mcq';
            
            if (!text) {
                alert('يرجى إدخال نص السؤال');
                return;
            }
            if (options.some(o => o === '')) {
                alert('يرجى ملء جميع الخيارات');
                return;
            }
            if (correct === '') {
                alert('يرجى اختيار الإجابة الصحيحة');
                return;
            }
            questions.push({ 
                text, 
                options, 
                correct: parseInt(correct),
                type 
            });
        }

        const lessons = getLessons();
        const newLesson = {
            id: editingId || Date.now().toString(),
            title: title,
            grade: grade,
            semester: semester,
            content: content,
            questions: questions
        };

        if (editingId) {
            const idx = lessons.findIndex(l => l.id === editingId);
            if (idx !== -1) lessons[idx] = newLesson;
        } else {
            lessons.push(newLesson);
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(lessons));
        alert('تم الحفظ بنجاح!');
        resetForm();
        renderLessons();
    }

    function editLesson(id) {
        const lesson = getLessons().find(l => l.id === id);
        if (!lesson) return;

        editingId = id;
        document.getElementById('lessonTitle').value = lesson.title;
        document.getElementById('lessonGrade').value = lesson.grade;
        document.getElementById('lessonSemester').value = lesson.semester;
        document.getElementById('lessonContent').value = lesson.content;

        document.getElementById('questionsContainer').innerHTML = '';
        if (lesson.questions) {
            lesson.questions.forEach(q => {
                addQuestionField(q.type || 'mcq', q);
            });
        }
        window.scrollTo(0, 0);
    }

    function deleteLesson(id) {
        if (confirm('هل أنت متأكد من حذف هذا النص؟')) {
            const lessons = getLessons().filter(l => l.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(lessons));
            renderLessons();
            if (editingId === id) resetForm();
        }
    }

    function resetForm() {
        editingId = null;
        document.getElementById('lessonForm').reset();
        document.getElementById('questionsContainer').innerHTML = '';
    }

    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<>"]/g, function(m) {
            if (m === '&') return '&amp;';
            if (m === '<') return '&lt;';
            if (m === '>') return '&gt;';
            if (m === '"') return '&quot;';
            return m;
        });
    }
</script>
</body>
</html>