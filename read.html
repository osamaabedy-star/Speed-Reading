<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Amiri&family=Tajawal:wght@400;700&family=Almarai:wght@400;700&family=Readex+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body * { font-family: inherit; }

        :root {
            --bg: #f8f9fa;
            --panel: rgba(255, 255, 255, 0.9);
            --text: #2b2d42;
            --primary: #4361ee;
            --accent: #f72585;
            --border: #e9eef2;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --success: #10b981;
        }

        [data-theme="dark"] {
            --bg: #1a1a2e;
            --panel: rgba(22, 33, 62, 0.95);
            --text: #e9eef2;
            --primary: #667eea;
            --accent: #f472b6;
            --border: #2d3748;
        }

        [data-theme="comfort"] {
            --bg: #e6d5b8;
            --panel: rgba(250, 240, 230, 0.95);
            --text: #5e4b3c;
            --primary: #b38b5d;
            --accent: #c44536;
            --border: #d4b89c;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        .top-bar {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            position: relative;
            flex-wrap: wrap;
            gap: 15px;
        }

        .lesson-info {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .school-logo-small {
            height: 40px;
            width: auto;
            border-radius: 8px;
        }

        .lesson-title {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--primary);
        }

        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .error-toast-top {
            position: absolute;
            top: 50%;
            right: 100%; /* ØªØ¸Ù‡Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
            transform: translateY(-50%);
            background: var(--accent);
            color: white;
            padding: 6px 15px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 150;
            margin-right: 10px;
        }
        .error-toast-top.show {
            opacity: 1;
        }
        .error-toast-top i {
            font-size: 1rem;
        }

        .stats {
            display: flex;
            gap: 20px;
            align-items: center;
            background: var(--bg);
            padding: 8px 20px;
            border-radius: 40px;
            box-shadow: var(--shadow);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        .stat-item i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--border);
        }

        #progressBar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.1s linear;
        }

        #reader-viewport {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            padding: 0; /* Ø¥Ø²Ø§Ù„Ø© padding Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Øµ Ø£Ù‚Ø±Ø¨ */
        }

        #rsvp-container {
            font-size: 4rem;
            font-weight: 700;
            text-align: center;
            display: none;
            width: 100%;
            padding: 0 20px;
        }
        .pivot { color: var(--accent); }

        /* ØªØ­Ø³ÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± - Ø§Ù„Ù†Øµ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© */
        #scroll-container {
            width: calc(100% - 100px); /* ØªØ±Ùƒ Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© */
            max-width: 1200px;
            font-size: 2.2rem;
            line-height: 1.8;
            text-align: justify;
            display: none;
            position: absolute;
            top: 20px;
            right: 70px; /* ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ 20px) */
            transform: translateY(100vh);
            will-change: transform;
            transition: font-size 0.2s, line-height 0.2s;
            white-space: pre-line;
            direction: rtl;
        }

        #static-container {
            width: calc(100% - 100px);
            max-width: 1200px;
            font-size: 1.8rem;
            line-height: 2;
            text-align: justify;
            display: none;
            overflow-y: auto;
            max-height: 80vh;
            padding: 20px;
            background: var(--panel);
            border-radius: 30px;
            box-shadow: var(--shadow);
            transition: font-size 0.2s, line-height 0.2s;
            margin-right: 70px; /* Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§ÙØ© */
        }

        .static-content {
            white-space: pre-wrap;
        }

        .error-word {
            background-color: rgba(239, 68, 68, 0.2);
            border-bottom: 2px solid #ef4444;
            cursor: pointer;
            transition: 0.2s;
        }

        #countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            font-weight: 800;
            color: var(--primary);
            z-index: 200;
        }

        /* ===== Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù‚Ø±ÙŠØ¨Ø© Ø¬Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ© ===== */
        .control-panel {
            position: fixed;
            right: 10px; /* Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø­Ø§ÙØ© */
            top: 55%;
            transform: translateY(-50%);
            background: var(--panel);
            backdrop-filter: blur(10px);
            border-radius: 35px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            z-index: 150;
            width: 40px;
        }

        .control-btn {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.95rem;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .control-btn:hover {
            background: var(--primary);
            color: white;
        }

        .speed-indicator {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.7rem;
            background: var(--bg);
            padding: 2px 0;
            width: 100%;
            text-align: center;
            border-radius: 20px;
        }

        .font-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            border-top: 2px solid var(--border);
            padding-top: 6px;
            margin-top: 2px;
        }

        .font-controls .control-btn {
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
        }

        .words-per-line-control {
            border-top: 2px solid var(--border);
            padding-top: 6px;
            margin-top: 2px;
            text-align: center;
            display: none;
            width: 100%;
        }

        .words-per-line-control span {
            font-size: 0.6rem;
            display: block;
            margin-bottom: 2px;
        }

        .wpl-buttons {
            display: flex;
            gap: 1px;
            justify-content: center;
            align-items: center;
        }

        .wpl-buttons .control-btn {
            width: 22px;
            height: 22px;
            font-size: 0.7rem;
        }

        #wordsPerLineValue {
            min-width: 22px;
            text-align: center;
            font-weight: bold;
            font-size: 0.7rem;
        }

        /* ===== Ø²Ø± Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ù…Ø§Ù„ Ù…Ø¹ Ù†Øµ ===== */
        .error-left-btn {
            position: fixed;
            bottom: 25px;
            left: 20px;
            background-color: var(--accent);
            color: white;
            border-radius: 40px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(247, 37, 133, 0.4);
            z-index: 200;
        }

        .error-left-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(247, 37, 133, 0.6);
        }

        .error-left-btn i {
            font-size: 1.3rem;
        }

        /* Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .loading {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 2rem;
            color: var(--primary);
        }

        .custom-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 300;
            visibility: hidden;
            opacity: 0;
            transition: 0.3s;
        }
        .custom-modal.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: var(--panel);
            padding: 30px;
            border-radius: 40px;
            text-align: center;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--primary);
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }
        .modal-btn.secondary {
            background: var(--border);
            color: var(--text);
        }
        .error-list {
            text-align: right;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            padding: 10px;
            background: var(--bg);
            border-radius: 20px;
        }
        .error-item {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            margin: 3px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body data-theme="light">
<div class="loading" id="loadingScreen"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</div>

<!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª -->
<div class="custom-modal" id="messageModal">
    <div class="modal-content">
        <i class="fas fa-info-circle" style="font-size: 3rem; color: var(--primary);" id="modalIcon"></i>
        <h3 id="modalTitle" style="margin: 15px 0;">Ø±Ø³Ø§Ù„Ø©</h3>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
            <button class="modal-btn primary" id="modalConfirmBtn">Ù…ÙˆØ§ÙÙ‚</button>
        </div>
    </div>
</div>

<div class="custom-modal" id="confirmModal">
    <div class="modal-content">
        <i class="fas fa-question-circle" style="font-size: 3rem; color: var(--warning);"></i>
        <h3 style="margin: 15px 0;">ØªØ£ÙƒÙŠØ¯</h3>
        <p id="confirmMessage"></p>
        <div class="modal-buttons">
            <button class="modal-btn primary" id="confirmYesBtn">Ù†Ø¹Ù…</button>
            <button class="modal-btn secondary" id="confirmNoBtn">Ù„Ø§</button>
        </div>
    </div>
</div>

<div class="custom-modal" id="reportModal">
    <div class="modal-content">
        <i class="fas fa-chart-bar" style="font-size: 3rem; color: var(--primary);"></i>
        <h2 style="margin: 15px 0;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</h2>
        <div style="text-align: right; margin: 20px 0;">
            <p><strong>ğŸ“Š Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø©:</strong> <span id="reportSpeed">0</span> ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©</p>
            <p><strong>ğŸ“„ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</strong> <span id="reportWords">0</span></p>
            <p><strong>âŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</strong> <span id="reportErrors">0</span></p>
            <div id="reportErrorWordsContainer">
                <p><strong>Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:</strong></p>
                <div class="error-list" id="reportErrorWords"></div>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn primary" id="reportQuestionsBtn">Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
            <button class="modal-btn secondary" id="reportHomeBtn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>
</div>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<div class="top-bar">
    <div class="lesson-info">
        <img src="https://www.wzufa.com/wp-content/uploads/2022/07/Riyadh-Al-Ebdaa-Schools.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" class="school-logo-small">
        <span class="lesson-title" id="lesson-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <span class="error-toast-top" id="errorToastTop">
            <i class="fas fa-check-circle"></i>
            <span>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£</span>
        </span>
    </div>
    <div class="stats">
        <div class="stat-item"><i class="far fa-clock"></i> <span id="timer">00:00</span></div>
        <div class="stat-item"><i class="fas fa-tachometer-alt"></i> <span id="speed-tag">150</span></div>
        <div class="stat-item"><i class="fas fa-font"></i> <span id="font-size-indicator">32</span></div>
    </div>
    <div class="progress-container">
        <div id="progressBar"></div>
    </div>
</div>

<!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ -->
<div id="reader-viewport">
    <div id="countdown"></div>
    <div id="rsvp-container"><div id="rsvp-word"></div></div>
    <div id="scroll-container"></div>
    <div id="static-container"><div class="static-content" id="static-content"></div></div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù‚Ø±ÙŠØ¨Ø© Ø¬Ø¯Ø§Ù‹ -->
<div class="control-panel">
    <button class="control-btn" id="playPauseBtn" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù"><i class="fas fa-play"></i></button>
    <button class="control-btn" id="stopBtn" title="Ø¥Ù†Ù‡Ø§Ø¡"><i class="fas fa-stop"></i></button>
    <span class="speed-indicator" id="speedDisplay">150</span>
    <button class="control-btn" id="speedUpBtn" title="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø©"><i class="fas fa-plus"></i></button>
    <button class="control-btn" id="speedDownBtn" title="Ø®ÙØ¶ Ø§Ù„Ø³Ø±Ø¹Ø©"><i class="fas fa-minus"></i></button>

    <div class="font-controls">
        <button class="control-btn" id="fontIncreaseBtn" title="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø·"><i class="fas fa-search-plus"></i></button>
        <button class="control-btn" id="fontDecreaseBtn" title="ØªØµØºÙŠØ± Ø§Ù„Ø®Ø·"><i class="fas fa-search-minus"></i></button>
        <button class="control-btn" id="lineHeightIncreaseBtn" title="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¨Ø§Ø¹Ø¯"><i class="fas fa-arrows-alt-v"></i></button>
        <button class="control-btn" id="lineHeightDecreaseBtn" title="ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ¨Ø§Ø¹Ø¯"><i class="fas fa-compress-alt"></i></button>
    </div>

    <div class="words-per-line-control" id="wplControl">
        <span>ÙƒÙ„Ù…Ø§Øª/Ø³Ø·Ø±</span>
        <div class="wpl-buttons">
            <button class="control-btn" id="wplDown"><i class="fas fa-minus"></i></button>
            <span id="wordsPerLineValue">10</span>
            <button class="control-btn" id="wplUp"><i class="fas fa-plus"></i></button>
        </div>
    </div>
</div>

<!-- Ø²Ø± Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ù…Ø§Ù„ Ù…Ø¹ Ù†Øµ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ RSVP) -->
<button class="error-left-btn" id="errorBtn" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£" style="display: none;">
    <i class="fas fa-exclamation-circle"></i>
    <span>Ø³Ø¬Ù„ Ø®Ø·Ø£</span>
</button>

<script>
    (function() {
        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.addEventListener('load', () => {
            document.getElementById('loadingScreen').style.display = 'none';
        });

        // Ø¹Ù†ØµØ± toast Ø§Ù„Ø¹Ù„ÙˆÙŠ
        const errorToastTop = document.getElementById('errorToastTop');
        function showErrorToastTop() {
            errorToastTop.classList.add('show');
            setTimeout(() => {
                errorToastTop.classList.remove('show');
            }, 1500);
        }

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØºØ±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù‡Ù†Ø¯ÙŠØ© (Ù„Ù„ØªÙ‚Ø±ÙŠØ±)
        function toIndianNumbers(num) {
            const arabicNumbers = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            return num.toString().replace(/\d/g, (d) => arabicNumbers[d]);
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø± Ø¨Ø¹Ø¯Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…ØªØºÙŠØ± Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª (HTML)
        function formatTextToFixedWordsHTML(text, wordsPerLine = 5) {
            const words = text.split(/\s+/);
            let lines = [];
            for (let i = 0; i < words.length; i += wordsPerLine) {
                let lineWords = words.slice(i, i + wordsPerLine);
                // ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ ÙƒÙ„Ù…Ø© Ø¥Ù„Ù‰ span Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø±
                let lineHTML = lineWords.map(word => 
                    `<span class="word" data-word="${escapeHtml(word)}" onclick="window.toggleError(this)">${escapeHtml(word)}</span>`
                ).join(' ');
                lines.push(lineHTML);
            }
            return lines.join('\n');
        }

        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        const config = JSON.parse(sessionStorage.getItem('reader_config'));
        if (!config) {
            alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.');
            window.location.href = 'index.html';
            return;
        }

        const allLessons = JSON.parse(localStorage.getItem('reading_app_lessons')) || [];
        const lesson = allLessons.find(l => l.id === config.lessonId);
        if (!lesson) {
            alert('Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
            window.location.href = 'index.html';
            return;
        }

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Øµ
        const words = lesson.content.trim().split(/\s+/);
        let currentIndex = 0;
        let isPlaying = false;
        let startTime = null;
        let timerInterval = null;
        let rafId = null;
        let currentSpeed = parseInt(config.speed) || 150;
        let rsvpTimer = null;
        let wordTimeMs = 60000 / currentSpeed;
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ±
        let scrollLastTimestamp = 0;
        let scrollCurrentY = 0;
        let scrollTotalDistance = 0;
        let scrollPixelsPerSecond = 0;
        
        // Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø·Ø± (Ù„Ù„ØªÙ…Ø±ÙŠØ±)
        let currentWordsPerLine = 10;
        
        // Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        let totalErrors = 0;
        let errorWordsList = [];

        // Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
        let currentFontSize = parseInt(config.fontSize) || 32;
        let currentLineHeight = 1.8;

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ…
        if (config.theme) {
            document.body.setAttribute('data-theme', config.theme);
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·
        document.body.style.fontFamily = config.font;

        // Ø¹Ù†Ø§ØµØ± DOM
        const lessonTitleEl = document.getElementById('lesson-title');
        const speedTagEl = document.getElementById('speed-tag');
        const speedDisplay = document.getElementById('speedDisplay');
        const timerEl = document.getElementById('timer');
        const fontSizeIndicator = document.getElementById('font-size-indicator');
        const rsvpContainer = document.getElementById('rsvp-container');
        const scrollContainer = document.getElementById('scroll-container');
        const staticContainer = document.getElementById('static-container');
        const staticContent = document.getElementById('static-content');
        const rsvpWordEl = document.getElementById('rsvp-word');
        const countdownEl = document.getElementById('countdown');
        const progressBar = document.getElementById('progressBar');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const speedUpBtn = document.getElementById('speedUpBtn');
        const speedDownBtn = document.getElementById('speedDownBtn');
        const fontIncreaseBtn = document.getElementById('fontIncreaseBtn');
        const fontDecreaseBtn = document.getElementById('fontDecreaseBtn');
        const lineHeightIncreaseBtn = document.getElementById('lineHeightIncreaseBtn');
        const lineHeightDecreaseBtn = document.getElementById('lineHeightDecreaseBtn');
        const errorBtn = document.getElementById('errorBtn');
        const wplControl = document.getElementById('wplControl');
        const wplUp = document.getElementById('wplUp');
        const wplDown = document.getElementById('wplDown');
        const wordsPerLineValue = document.getElementById('wordsPerLineValue');

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        const messageModal = document.getElementById('messageModal');
        const modalIcon = document.getElementById('modalIcon');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        const reportModal = document.getElementById('reportModal');
        const reportSpeed = document.getElementById('reportSpeed');
        const reportWords = document.getElementById('reportWords');
        const reportErrors = document.getElementById('reportErrors');
        const reportErrorWordsContainer = document.getElementById('reportErrorWordsContainer');
        const reportErrorWords = document.getElementById('reportErrorWords');
        const reportQuestionsBtn = document.getElementById('reportQuestionsBtn');
        const reportHomeBtn = document.getElementById('reportHomeBtn');

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        function showMessage(msg, title = 'Ø±Ø³Ø§Ù„Ø©', type = 'info', onConfirm = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = msg;
            if (type === 'error') {
                modalIcon.className = 'fas fa-exclamation-circle';
                modalIcon.style.color = 'var(--danger)';
            } else if (type === 'success') {
                modalIcon.className = 'fas fa-check-circle';
                modalIcon.style.color = 'var(--success)';
            } else {
                modalIcon.className = 'fas fa-info-circle';
                modalIcon.style.color = 'var(--primary)';
            }
            messageModal.classList.add('show');
            modalConfirmBtn.onclick = () => {
                messageModal.classList.remove('show');
                if (onConfirm) onConfirm();
            };
        }

        function showConfirm(msg, onYes, onNo) {
            confirmMessage.textContent = msg;
            confirmModal.classList.add('show');
            confirmYesBtn.onclick = () => {
                confirmModal.classList.remove('show');
                if (onYes) onYes();
            };
            confirmNoBtn.onclick = () => {
                confirmModal.classList.remove('show');
                if (onNo) onNo();
            };
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        reportQuestionsBtn.onclick = () => {
            reportModal.classList.remove('show');
            window.location.href = 'questions.html';
        };
        reportHomeBtn.onclick = () => {
            reportModal.classList.remove('show');
            window.location.href = 'index.html';
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹
        lessonTitleEl.innerText = lesson.title;
        updateSpeedDisplay();
        updateFontSizeDisplay();

        if (config.mode === 'rsvp') {
            rsvpContainer.style.display = 'block';
            rsvpContainer.style.fontSize = currentFontSize + 'px';
            errorBtn.style.display = 'flex';        // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ RSVP
            wplControl.style.display = 'none';
        } else if (config.mode === 'scroll') {
            scrollContainer.style.display = 'block';
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… HTML Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
            scrollContainer.innerHTML = formatTextToFixedWordsHTML(lesson.content, currentWordsPerLine);
            scrollContainer.style.fontSize = currentFontSize + 'px';
            scrollContainer.style.lineHeight = currentLineHeight;
            const viewportHeight = window.innerHeight;
            scrollCurrentY = viewportHeight;
            scrollContainer.style.transform = `translateY(${scrollCurrentY}px)`;
            errorBtn.style.display = 'none';        // Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„ØªÙ…Ø±ÙŠØ±
            wplControl.style.display = 'block';
            wordsPerLineValue.innerText = currentWordsPerLine;
            setTimeout(() => {
                recalcScrollDistance();
            }, 100);
        } else if (config.mode === 'static') {
            staticContainer.style.display = 'block';
            staticContent.innerText = lesson.content;
            staticContainer.style.fontSize = (currentFontSize - 4) + 'px';
            staticContainer.style.lineHeight = currentLineHeight;
            enableErrorSelection();
            errorBtn.style.display = 'none';        // Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ø¨Øª
            wplControl.style.display = 'none';
        }

        function updateFontSizeDisplay() {
            fontSizeIndicator.innerText = currentFontSize;
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø£Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¹Ø¯Ù… ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù†Øµ)
        function recalcScrollDistance(keepPosition = true) {
            if (config.mode !== 'scroll') return;

            // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù‚ÙŠÙ…Ø© Y) Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡
            const oldY = scrollCurrentY;

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† HTML Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
            scrollContainer.innerHTML = formatTextToFixedWordsHTML(lesson.content, currentWordsPerLine);
            
            const textHeight = scrollContainer.offsetHeight;
            const viewportHeight = window.innerHeight;
            const newTotalDistance = textHeight + viewportHeight;
            
            if (keepPosition) {
                // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ø±Ø£Ø³ÙŠØ© (Ù„Ø§ Ù†ØºÙŠØ± scrollCurrentY)
                // ÙˆÙ„ÙƒÙ† Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¶Ø¨Ø·Ù‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                const maxY = - (newTotalDistance - viewportHeight);
                if (scrollCurrentY > 0) scrollCurrentY = 0;
                if (scrollCurrentY < maxY) scrollCurrentY = maxY;
            } else {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù†Ø§Ø¯Ø± Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…)
                scrollCurrentY = viewportHeight;
            }
            
            scrollTotalDistance = newTotalDistance;
            const totalSeconds = (words.length / currentSpeed) * 60;
            scrollPixelsPerSecond = scrollTotalDistance / totalSeconds;
            
            scrollContainer.style.transform = `translateY(${scrollCurrentY}px)`;

            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            const progress = Math.min(100, Math.max(0, ((-scrollCurrentY) / scrollTotalDistance) * 100));
            progressBar.style.width = progress + '%';
        }

        function startCountdown() {
            let count = 3;
            countdownEl.style.display = 'block';
            const interval = setInterval(() => {
                if (count > 0) {
                    countdownEl.innerText = count;
                } else if (count === 0) {
                    countdownEl.innerText = "Ø§Ù†Ø·Ù„Ù‚!";
                } else {
                    clearInterval(interval);
                    countdownEl.style.display = 'none';
                    startReading();
                }
                count--;
            }, 500);
        }

        function updateSpeedDisplay() {
            speedTagEl.innerText = currentSpeed;
            speedDisplay.innerText = currentSpeed;
            wordTimeMs = 60000 / currentSpeed;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        // ===== ÙƒÙˆØ¯ Ù…Ù†Ø¹ ØºÙ„Ù‚ Ø§Ù„Ø´Ø§Ø´Ø© (Screen Wake Lock) =====
        let wakeLock = null;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('ØªÙ… ØªØ­Ø±ÙŠØ± Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©');
                    });
                    console.log('ØªÙ… ØªÙØ¹ÙŠÙ„ Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©');
                } else {
                    console.warn('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…Ù†Ø¹ ØºÙ„Ù‚ Ø§Ù„Ø´Ø§Ø´Ø©');
                }
            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release()
                    .then(() => {
                        wakeLock = null;
                        console.log('ØªÙ… ØªØ­Ø±ÙŠØ± Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    })
                    .catch((err) => {
                        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø±ÙŠØ± Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©:', err);
                    });
            }
        }
        // =================================================

        function startReading() {
            isPlaying = true;
            startTime = Date.now();
            startTimer();
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            requestWakeLock(); // Ø·Ù„Ø¨ Ù…Ù†Ø¹ ØºÙ„Ù‚ Ø§Ù„Ø´Ø§Ø´Ø©

            if (config.mode === 'rsvp') {
                currentIndex = 0;
                scheduleNextRSVP();
            } else if (config.mode === 'scroll') {
                scrollLastTimestamp = 0;
                rafId = requestAnimationFrame(scrollStep);
            }
        }

        function cleanWord(word) {
            return word.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?ØŸØŒâ€¦]/g, '');
        }

        function hasPunctuation(word) {
            return /[.!?ØŒØ›:]$/.test(word);
        }

        function scheduleNextRSVP() {
            if (!isPlaying || currentIndex >= words.length) {
                if (currentIndex >= words.length) finish();
                return;
            }

            displayWord(currentIndex);
            progressBar.style.width = ((currentIndex + 1) / words.length) * 100 + '%';
            
            const currentWord = words[currentIndex];
            currentIndex++;

            if (currentIndex < words.length) {
                let delay = wordTimeMs;
                if (hasPunctuation(currentWord)) {
                    delay *= 1.5;
                }
                rsvpTimer = setTimeout(scheduleNextRSVP, delay);
            } else {
                setTimeout(finish, wordTimeMs);
            }
        }

        function displayWord(index) {
            let word = words[index];
            const clean = cleanWord(word);
            const pivotIdx = Math.floor(clean.length / 2);
            const before = clean.substring(0, pivotIdx);
            const pivot = clean[pivotIdx];
            const after = clean.substring(pivotIdx + 1);
            rsvpWordEl.innerHTML = `${escapeHtml(before)}<span class="pivot">${escapeHtml(pivot)}</span>${escapeHtml(after)}`;
        }

        function scrollStep(timestamp) {
            if (!isPlaying) return;

            if (!scrollLastTimestamp) {
                scrollLastTimestamp = timestamp;
                rafId = requestAnimationFrame(scrollStep);
                return;
            }

            const elapsed = (timestamp - scrollLastTimestamp) / 1000;
            const delta = scrollPixelsPerSecond * elapsed;
            scrollCurrentY -= delta;
            scrollContainer.style.transform = `translateY(${scrollCurrentY}px)`;

            const progress = Math.min(100, Math.max(0, ((-scrollCurrentY) / scrollTotalDistance) * 100));
            progressBar.style.width = progress + '%';

            scrollLastTimestamp = timestamp;

            if (-scrollCurrentY < scrollTotalDistance - window.innerHeight) {
                rafId = requestAnimationFrame(scrollStep);
            } else {
                finish();
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£ (ØªØ³ØªØ®Ø¯Ù… ÙÙŠ RSVP Ø¹Ø¨Ø± Ø§Ù„Ø²Ø±)
        function recordError() {
            if (!isPlaying) return;
            totalErrors++;
            
            if (config.mode === 'rsvp' && currentIndex > 0) {
                const errorWord = words[currentIndex - 1];
                errorWordsList.push(errorWord);
                // ØªØ£Ø«ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø©
                const wordElement = rsvpWordEl;
                wordElement.style.transition = 'color 0.2s';
                wordElement.style.color = 'var(--accent)';
                setTimeout(() => {
                    wordElement.style.color = '';
                }, 300);
            }
            
            showErrorToastTop(); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
        }

        // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø®Ø·Ø£ (ÙÙ‚Ø· ÙÙŠ RSVP)
        errorBtn.addEventListener('click', recordError);

        // ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ø¨Øª
        function enableErrorSelection() {
            const text = lesson.content;
            const wordsArray = text.split(/(\s+)/);
            let html = '';
            wordsArray.forEach((segment, idx) => {
                if (segment.trim().length > 0 && idx % 2 === 0) {
                    const cleanWord = segment.trim();
                    html += `<span class="word" data-word="${escapeHtml(cleanWord)}" onclick="window.toggleError(this)">${escapeHtml(cleanWord)}</span>`;
                } else {
                    html += segment;
                }
            });
            staticContent.innerHTML = html;
        }

        window.toggleError = function(element) {
            if (!isPlaying) return;
            element.classList.toggle('error-word');
            const word = element.getAttribute('data-word');
            if (element.classList.contains('error-word')) {
                totalErrors++;
                errorWordsList.push(word);
                showErrorToastTop();
            } else {
                totalErrors--;
                const index = errorWordsList.indexOf(word);
                if (index !== -1) errorWordsList.splice(index, 1);
            }
        };

        function startTimer() {
            timerInterval = setInterval(() => {
                if (startTime) {
                    const diff = Math.floor((Date.now() - startTime) / 1000);
                    timerEl.innerHTML = formatTime(diff);
                }
            }, 1000);
        }

        function togglePlay() {
            if (!startTime) return;
            isPlaying = !isPlaying;
            playPauseBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';

            if (isPlaying) {
                if (config.mode === 'rsvp') {
                    scheduleNextRSVP();
                } else if (config.mode === 'scroll') {
                    scrollLastTimestamp = 0;
                    rafId = requestAnimationFrame(scrollStep);
                }
            } else {
                if (rsvpTimer) {
                    clearTimeout(rsvpTimer);
                    rsvpTimer = null;
                }
                if (rafId) {
                    cancelAnimationFrame(rafId);
                    rafId = null;
                }
            }
        }

        function stopReading() {
            showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢Ù†ØŸ', () => {
                finish();
            }, () => {});
        }

        function finish() {
            releaseWakeLock(); // ØªØ­Ø±ÙŠØ± Ù…Ù†Ø¹ ØºÙ„Ù‚ Ø§Ù„Ø´Ø§Ø´Ø©
            clearInterval(timerInterval);
            if (rsvpTimer) {
                clearTimeout(rsvpTimer);
                rsvpTimer = null;
            }
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            isPlaying = false;

            const endTime = Date.now();
            const duration = Math.floor((endTime - startTime) / 1000);
            
            let wordsRead = 0;
            if (config.mode === 'rsvp') {
                wordsRead = currentIndex;
            } else {
                wordsRead = words.length;
            }
            const minutes = duration / 60;
            const avgSpeed = minutes > 0 ? Math.round(wordsRead / minutes) : 0;

            // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            reportSpeed.textContent = toIndianNumbers(avgSpeed);
            reportWords.textContent = toIndianNumbers(words.length);
            reportErrors.textContent = toIndianNumbers(totalErrors);
            
            if (errorWordsList.length > 0) {
                reportErrorWordsContainer.style.display = 'block';
                reportErrorWords.innerHTML = errorWordsList.map(w => `<span class="error-item">${escapeHtml(w)}</span>`).join('');
            } else {
                reportErrorWordsContainer.style.display = 'none';
            }

            reportModal.classList.add('show');

            // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
            const sessionData = {
                lessonId: config.lessonId,
                lessonTitle: lesson.title,
                grade: lesson.grade,
                semester: lesson.semester,
                totalWords: words.length,
                duration: duration,
                speed: currentSpeed,
                errors: totalErrors,
                startTime: startTime,
                endTime: endTime,
                theme: config.theme,
                questions: lesson.questions || []
            };
            sessionStorage.setItem('currentReadingSession', JSON.stringify(sessionData));
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø£Ø³ÙŠ (Ø¹Ø¯Ù… ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù†Øµ)
        playPauseBtn.addEventListener('click', togglePlay);
        stopBtn.addEventListener('click', stopReading);

        speedUpBtn.addEventListener('click', () => {
            let newSpeed = Number(currentSpeed) + 10;
            if (newSpeed > 400) newSpeed = 400;
            currentSpeed = newSpeed;
            updateSpeedDisplay();
            if (config.mode === 'scroll') {
                if (isPlaying) {
                    // ØªØ­Ø¯ÙŠØ« Ø³Ø±Ø¹Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙ‚Ø·
                    const totalSeconds = (words.length / currentSpeed) * 60;
                    scrollPixelsPerSecond = scrollTotalDistance / totalSeconds;
                } else {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Ù‚Ø¯ ØªØªØºÙŠØ± Ø¨Ø³Ø¨Ø¨ ØªØºÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø©ØŸ Ù„Ø§ØŒ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø«Ø§Ø¨ØªØ©ØŒ ÙÙ‚Ø· Ø§Ù„Ø³Ø±Ø¹Ø©)
                    // Ù†Ø³ØªØ¯Ø¹ÙŠ recalcScrollDistance Ù…Ø¹ true Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹
                    recalcScrollDistance(true);
                }
            }
        });

        speedDownBtn.addEventListener('click', () => {
            let newSpeed = Number(currentSpeed) - 10;
            if (newSpeed < 10) newSpeed = 10;
            currentSpeed = newSpeed;
            updateSpeedDisplay();
            if (config.mode === 'scroll') {
                if (isPlaying) {
                    const totalSeconds = (words.length / currentSpeed) * 60;
                    scrollPixelsPerSecond = scrollTotalDistance / totalSeconds;
                } else {
                    recalcScrollDistance(true);
                }
            }
        });

        wplUp.addEventListener('click', () => {
            if (currentWordsPerLine < 20) {
                currentWordsPerLine++;
                wordsPerLineValue.innerText = currentWordsPerLine;
                if (config.mode === 'scroll') {
                    recalcScrollDistance(true); // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹
                }
            }
        });

        wplDown.addEventListener('click', () => {
            if (currentWordsPerLine > 1) {
                currentWordsPerLine--;
                wordsPerLineValue.innerText = currentWordsPerLine;
                if (config.mode === 'scroll') {
                    recalcScrollDistance(true); // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹
                }
            }
        });

        fontIncreaseBtn.addEventListener('click', () => {
            if (currentFontSize < 96) {
                currentFontSize += 4;
                if (config.mode === 'rsvp') {
                    rsvpContainer.style.fontSize = currentFontSize + 'px';
                } else if (config.mode === 'scroll') {
                    scrollContainer.style.fontSize = currentFontSize + 'px';
                    recalcScrollDistance(true); // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹
                } else if (config.mode === 'static') {
                    staticContainer.style.fontSize = currentFontSize + 'px';
                }
                updateFontSizeDisplay();
            }
        });

        fontDecreaseBtn.addEventListener('click', () => {
            if (currentFontSize > 12) {
                currentFontSize -= 4;
                if (config.mode === 'rsvp') {
                    rsvpContainer.style.fontSize = currentFontSize + 'px';
                } else if (config.mode === 'scroll') {
                    scrollContainer.style.fontSize = currentFontSize + 'px';
                    recalcScrollDistance(true); // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹
                } else if (config.mode === 'static') {
                    staticContainer.style.fontSize = currentFontSize + 'px';
                }
                updateFontSizeDisplay();
            }
        });

        lineHeightIncreaseBtn.addEventListener('click', () => {
            currentLineHeight += 0.2;
            if (config.mode === 'scroll') {
                scrollContainer.style.lineHeight = currentLineHeight;
                recalcScrollDistance(true); // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹
            } else if (config.mode === 'static') {
                staticContainer.style.lineHeight = currentLineHeight;
            }
        });

        lineHeightDecreaseBtn.addEventListener('click', () => {
            if (currentLineHeight > 1.2) {
                currentLineHeight -= 0.2;
                if (config.mode === 'scroll') {
                    scrollContainer.style.lineHeight = currentLineHeight;
                    recalcScrollDistance(true); // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶Ø¹
                } else if (config.mode === 'static') {
                    staticContainer.style.lineHeight = currentLineHeight;
                }
            }
        });

        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ viewport ÙÙ‚Ø· Ù„ÙˆØ¶Ø¹ RSVP (ÙˆÙ„ÙŠØ³ Ù„Ù„ØªÙ…Ø±ÙŠØ±)
        if (config.mode === 'rsvp') {
            document.getElementById('reader-viewport').addEventListener('click', togglePlay);
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                togglePlay();
            } else if (e.code === 'ArrowUp') {
                e.preventDefault();
                speedUpBtn.click();
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                speedDownBtn.click();
            }
        });

        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
        startCountdown();
    })();
</script>
</body>
</html>
